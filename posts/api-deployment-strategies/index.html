<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>API Deployment Strategies | Navendu Pottekkat</title><meta name=keywords content="apache apisix,api gateway,cloud-native"><meta name=description content="Applying best practices to make new API deployments using the API gateway of choice, Apache APISIX."><meta name=author content="Navendu Pottekkat"><link rel=canonical href=https://navendu.me/posts/api-deployment-strategies/><script defer data-domain=navendu.me src=/misc/js/script.js data-api=/misc/api/event></script><script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><script></script><link crossorigin=anonymous href=/assets/css/stylesheet.66e3e513d75c2ff303648a5691fa6787b3c8f1dc4b3307618713a4dc494f0696.css integrity="sha256-ZuPlE9dcL/MDZIpWkfpnh7PI8dxLMwdhhxOk3ElPBpY=" rel="preload stylesheet" as=style><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://navendu.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://navendu.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://navendu.me/favicon-32x32.png><link rel=apple-touch-icon href=https://navendu.me/apple-touch-icon.png><link rel=mask-icon href=https://navendu.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="API Deployment Strategies"><meta property="og:description" content="Applying best practices to make new API deployments using the API gateway of choice, Apache APISIX."><meta property="og:type" content="article"><meta property="og:url" content="https://navendu.me/posts/api-deployment-strategies/"><meta property="og:image" content="https://navendu.me/images/api-deployment-strategies/shadow-banner.jpeg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-15T19:55:51+05:30"><meta property="article:modified_time" content="2023-09-15T20:17:45+05:30"><meta property="og:site_name" content="Navendu Pottekkat"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://navendu.me/images/api-deployment-strategies/shadow-banner.jpeg"><meta name=twitter:title content="API Deployment Strategies"><meta name=twitter:description content="Applying best practices to make new API deployments using the API gateway of choice, Apache APISIX."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://navendu.me/posts/"},{"@type":"ListItem","position":2,"name":"API Deployment Strategies","item":"https://navendu.me/posts/api-deployment-strategies/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"API Deployment Strategies","name":"API Deployment Strategies","description":"Applying best practices to make new API deployments using the API gateway of choice, Apache APISIX.","keywords":["apache apisix","api gateway","cloud-native"],"articleBody":"Deploying changes to your APIs without impacting clients is vital in most modern software products. In this article, I will focus on some best practices and strategies you can adopt to streamline the deployment of your APIs using API gateways.\nThroughout this tutorial, we will use our API gateway of choice, Apache APISIX, but you can translate these strategies to any other API gateway or reverse proxy.\nAPI Versions Yes, even that minor change can potentially break your client applications.\nAPI versioning is the most straightforward strategy to make changes to your APIs without disrupting your clients. By versioning, you can let your clients decide whether to upgrade to the new API version. They can also update their applications to the new API at their own pace.\nAPI gateways like APISIX can handle typical scenarios where your clients specify which version of the API to use in their requests. The version is typically specified in one of three ways:\n In URI path (/v1/products and /v2/products) In query parameters (/products?version=v1 and /products?version=v2) In custom request headers (/products version: v1 and /products version: v2) or the Accept header (/products Accept: application/vnd.shoppingapp.product.v1+json)  APISIX can then be configured to route these requests to the appropriate API version.\nIn URI Path The example below shows how you can route traffic to different versions based on the path specified in the URI:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/v1/products\", \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"api-v1:80\": 1 } }, \"plugins\": { \"proxy-rewrite\": { \"uri\": \"/products\" } } }' curl http://127.0.0.1:9180/apisix/admin/routes/2 -X PUT -d ' { \"uri\": \"/v2/products\", \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"api-v2:80\": 1 } }, \"plugins\": { \"proxy-rewrite\": { \"uri\": \"/products\" } } }' This configuration will route requests to path /v1/products to the v1 service and the requests to the v2/products path to the v2 service.\nTo forward requests to all paths to specific API versions, you can use regular expressions in your configuration:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/v1/*\", \"plugins\": { \"proxy-rewrite\": { \"regex_uri\": [\"/v1/(.*)\", \"/$1\"] } }, \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"api-v1:80\": 1 } } }' In Query Parameters Here, APISIX is configured to route traffic based on the version specified in the query parameter version. If the parameter has a value v1, the request is routed to the v1 service, and if it has the value v2, the request is routed to the v2 service:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/products\", \"vars\": [[\"arg_version\", \"==\", \"v1\"]], \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"api-v1:80\": 1 } } }' curl http://127.0.0.1:9180/apisix/admin/routes/2 -X PUT -d ' { \"uri\": \"/products\", \"vars\": [[\"arg_version\", \"==\", \"v2\"]], \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"api-v2:80\": 1 } } }' In Request Headers Similar to routing based on query parameters, the below configuration routes requests based on headers. While arg_ checks for  in the query parameters, http_ checks for the  in the request headers:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/products\", \"vars\": [[\"http_version\", \"==\", \"v1\"]], \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"api-v1:80\": 1 } } }' curl http://127.0.0.1:9180/apisix/admin/routes/2 -X PUT -d ' { \"uri\": \"/products\", \"vars\": [[\"http_version\", \"==\", \"v2\"]], \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"api-v2:80\": 1 } } }' If you are using the Accept header, you can use the configuration below:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/products\", \"vars\": [[\"http_accept\", \"==\", \"application/vnd.shoppingapp.product.v1+json\"]], \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"api-v1:80\": 1 } } }' Backwards Compatible APIs Multiple API versions cannot always get you far and sometimes, change is inevitable. A strategy to make changes to your API without breaking your client applications is to ensure backwards compatibility. i.e., the interface between your clients and the API remains the same while your API changes.\nFor example, if you change your API endpoint (from /old/api to /new/api), an API gateway can redirect client requests to the new API endpoint without changes to the client applications.\nAPISIX implements this through the redirect and the proxy-rewrite plugins. The example below shows how you can configure redirects:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/old/api/products\", \"plugins\": { \"redirect\": { \"uri\": \"/new/api/products\", \"ret_code\": 301 } } }'  Note: Client applications need to be configured to follow redirects for this configuration to work.\n There could be more complex scenarios where the client-API interface changes. For instance, if the new API expects the key fullName instead of firstName and lastName, clients sending requests in the old API format would break. APISIX can handle such scenarios through the body-transformer plugin.\nThe example below shows how APISIX can transform the request body to make your APIs backwards compatible:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/login\", \"plugins\": { \"body-transformer\": { \"request\": { \"template\": \"{ \\\"fullName\\\": \\\"{{ firstName }} {{ lastName }}\\\" }\" } } }, \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"v2:80\": 1 } } }' Now a request body like,\n{ \"firstName\": \"Navendu\", \"lastName\": \"Pottekkat\" } will be transformed to:\n{ \"fullName\": \"Navendu Pottekkat\" } Similar transformations at the API gateway level should only be a temporary measure to ensure backwards compatibility as it could add costs in terms of latency or resource use.\nShadow Deployments Shadow deployment is a strategy to test new APIs with production traffic. This idea stems from the fact that handwritten test cases might not always simulate every complex real-world scenario.\nTypically, a shadow deployment is carried out by mirroring (sending a copy) production traffic to the new API and ignoring its responses. This lets you test application errors and performance by examining logs and metrics with production traffic without really deploying your new API to production.\nAPISIX has a proxy-mirror plugin that mirrors traffic to another service. The example below shows how you can configure the plugin on a specific route:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/products\", \"plugins\": { \"proxy-mirror\": { \"host\": \"http://v2:80\" } }, \"upstream\": { \"nodes\": { \"v1:80\": 1 }, \"type\": \"roundrobin\" } }' Once the plugin is configured, you can examine the logs and metrics from the gateway and your APIs using observability tools like Prometheus or Elasticsearch.\nA key advantage of shadow deployments is the zero production impact. You can test your APIs with production traffic in a sandboxed test environment. However, you should ensure the test environment is sandboxed and does not send duplicate requests to other production services. This is usually achieved by using mock services.\nCanary Deployments A canary deployment strategy can be quite helpful when you want to decouple the release of a new API from its deployment.\nIn a canary deployment, initially, a small percentage of traffic (say 10%) is routed to the new API version, while the rest remains to be routed to the existing API version. This allows you to test the new API in production for bugs without impacting a lot of your clients. Once the new API is deemed ready, traffic routed to it is gradually increased to 100%.\nAPISIX can achieve this routing through the traffic-split plugin. The example below shows how you can configure this plugin on a specific route:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/products\", \"plugins\": { \"traffic-split\": { \"rules\": [ { \"weighted_upstreams\": [ { \"upstream\": { \"name\": \"v1\", \"type\": \"roundrobin\", \"nodes\": { \"v1:80\": 1 } }, \"weight\": 90 }, { \"weight\": 10 } ] } ] } }, \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"v2:80\": 1 } } }' There are similar strategies like blue-green deployments where half of the traffic is routed to one API version, and the other half is routed to the new API version. This can be configured by setting 50-50 weights in the traffic-split plugin:\ncurl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d ' { \"uri\": \"/products\", \"plugins\": { \"traffic-split\": { \"rules\": [ { \"weighted_upstreams\": [ { \"upstream\": { \"name\": \"v1\", \"type\": \"roundrobin\", \"nodes\": { \"v1:80\": 1 } }, \"weight\": 50 }, { \"weight\": 50 } ] } ] } }, \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"v2:80\": 1 } } }' You can also set up A/B testing, a blue-green deployment with more emphasis on testing and experimentation than deploying new API versions. Bobur discusses some of these strategies in detail in this article.\nFeature Flags Sometimes, you want to test new features that do not involve changes to the client-API interface. In such scenarios, running a new API version with this additional feature might require more resources than necessary.\nA simple strategy is configuring feature flags that are dynamic on/off switches in your APIs. An API gateway can act as the feature flag service that all your APIs can listen to decide whether to enable or disable a feature. This works well because the API gateway is already central to your APIs, and there is no need to set up an additional service just to manage the feature flags.\nAPISIX can add feature-specific headers to requests from specific client groups, like beta testers using the proxy-rewrite plugin. Your API can then check if this header exists and allow access to new features to these clients without exposing it generally.\nThe example below adds a Beta header to clients in the beta_testers consumer group:\ncurl http://127.0.0.1:9180/apisix/admin/consumer_groups/beta_testers -X PUT -d ' { \"plugins\": { \"proxy-rewrite\": { \"headers\": { \"set\": { \"Beta\": \"true\" } } } } }' Communication Communicating with your clients is the most crucial strategy to complement all these strategies. Regardless of which other strategy you pick, communicating it with your clients beforehand can ensure that they are not caught off-guard and have sufficient time to adapt.\nCompanies like Google, Facebook, and Twitter, which have a large number of clients using their APIs, have frequently introduced breaking changes to their APIs. However, these companies have ensured that they communicate these changes, provide assistance and documentation to migrate to new API versions, and offer long deprecation periods to ensure clients can transition smoothly.\nThe best strategies are often simple.\nTo learn more about Apache APISIX, visit apisix.apache.org.\n","wordCount":"1650","inLanguage":"en","image":"https://navendu.me/images/api-deployment-strategies/shadow-banner.jpeg","datePublished":"2023-09-15T19:55:51+05:30","dateModified":"2023-09-15T20:17:45+05:30","author":{"@type":"Person","name":"Navendu Pottekkat"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://navendu.me/posts/api-deployment-strategies/"},"publisher":{"@type":"Person","name":"Navendu Pottekkat","logo":{"@type":"ImageObject","url":"https://navendu.me/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://navendu.me/ accesskey=h title="Navendu Pottekkat (Alt + H)">Navendu Pottekkat</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://navendu.me/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://navendu.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://navendu.me/dailies/ title="Daily Logs"><span>Daily Logs</span></a></li><li><a href=https://navendu.me/about/ title=About><span>About</span></a></li><li><a href=https://navendu.me/subscribe/ title=Subscribe><span>Subscribe</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://navendu.me/>Home</a>&nbsp;»&nbsp;<a href=https://navendu.me/posts/>Posts</a></div><h1 class=post-title>API Deployment Strategies</h1><div class=post-meta><span title="2023-09-15 19:55:51 +0530 +0530">September 15, 2023</span>&nbsp;·&nbsp;8 min&nbsp;|&nbsp;<a href=https://github.com/pottekkat/personal-website/blob/hugo/content/posts/api-deployment-strategies.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://navendu.me/images/api-deployment-strategies/shadow-banner.jpeg alt="Shadow in a parking lot."><p>Deploying changes without affecting users is key to a good deployment strategy.</p></figure><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on twitter" href="https://twitter.com/intent/tweet/?text=API%20Deployment%20Strategies&url=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f&hashtags=apacheapisix%2capigateway%2ccloud-native"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f&title=API%20Deployment%20Strategies&summary=API%20Deployment%20Strategies&source=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f&title=API%20Deployment%20Strategies"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on whatsapp" href="https://api.whatsapp.com/send?text=API%20Deployment%20Strategies%20-%20https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on telegram" href="https://telegram.me/share/url?text=API%20Deployment%20Strategies&url=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#api-versions aria-label="API Versions">API Versions</a><ul><li><a href=#in-uri-path aria-label="In URI Path">In URI Path</a></li><li><a href=#in-query-parameters aria-label="In Query Parameters">In Query Parameters</a></li><li><a href=#in-request-headers aria-label="In Request Headers">In Request Headers</a></li></ul></li><li><a href=#backwards-compatible-apis aria-label="Backwards Compatible APIs">Backwards Compatible APIs</a></li><li><a href=#shadow-deployments aria-label="Shadow Deployments">Shadow Deployments</a></li><li><a href=#canary-deployments aria-label="Canary Deployments">Canary Deployments</a></li><li><a href=#feature-flags aria-label="Feature Flags">Feature Flags</a></li><li><a href=#communication aria-label=Communication>Communication</a></li></ul></div></details></div><div class=post-content><p>Deploying changes to your APIs without impacting clients is vital in most modern software products. In this article, I will focus on some best practices and strategies you can adopt to streamline the deployment of your APIs using API gateways.</p><p>Throughout this tutorial, we will use our API gateway of choice, <a href="https://apisix.apache.org/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=api-deployment-strategies" target=_blank>Apache APISIX</a>, but you can translate these strategies to any other <a href=/posts/gateway-and-mesh/>API gateway</a> or reverse proxy.</p><h2 id=api-versions>API Versions<a hidden class=anchor aria-hidden=true href=#api-versions>#</a></h2><p>Yes, even that minor change can potentially break your client applications.</p><p>API versioning is the most straightforward strategy to make changes to your APIs without disrupting your clients. By versioning, you can let your clients decide whether to upgrade to the new API version. They can also update their applications to the new API at their own pace.</p><p>API gateways like APISIX can handle typical scenarios where your clients specify which version of the API to use in their requests. The version is typically specified in one of three ways:</p><ol><li>In URI path (<code>/v1/products</code> and <code>/v2/products</code>)</li><li>In query parameters (<code>/products?version=v1</code> and <code>/products?version=v2</code>)</li><li>In custom request headers (<code>/products version: v1</code> and <code>/products version: v2</code>) or the <code>Accept</code> header (<code>/products Accept: application/vnd.shoppingapp.product.v1+json</code>)</li></ol><p>APISIX can then be configured to route these requests to the appropriate API version.</p><h3 id=in-uri-path>In URI Path<a hidden class=anchor aria-hidden=true href=#in-uri-path>#</a></h3><p>The example below shows how you can route traffic to different versions based on the path specified in the URI:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/v1/products&#34;,
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;api-v1:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;proxy-rewrite&#34;: {
</span><span style=color:#e6db74>      &#34;uri&#34;: &#34;/products&#34;
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/2 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/v2/products&#34;,
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;api-v2:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;proxy-rewrite&#34;: {
</span><span style=color:#e6db74>      &#34;uri&#34;: &#34;/products&#34;
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><p>This configuration will route requests to path <code>/v1/products</code> to the <code>v1</code> service and the requests to the <code>v2/products</code> path to the <code>v2</code> service.</p><p>To forward requests to all paths to specific API versions, you can use regular expressions in your configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/v1/*&#34;,
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;proxy-rewrite&#34;: {
</span><span style=color:#e6db74>      &#34;regex_uri&#34;: [&#34;/v1/(.*)&#34;, &#34;/$1&#34;]
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;api-v1:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><h3 id=in-query-parameters>In Query Parameters<a hidden class=anchor aria-hidden=true href=#in-query-parameters>#</a></h3><p>Here, APISIX is configured to route traffic based on the version specified in the query parameter <code>version</code>. If the parameter has a value <code>v1</code>, the request is routed to the <code>v1</code> service, and if it has the value <code>v2</code>, the request is routed to the <code>v2</code> service:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/products&#34;,
</span><span style=color:#e6db74>  &#34;vars&#34;: [[&#34;arg_version&#34;, &#34;==&#34;, &#34;v1&#34;]],
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;api-v1:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/2 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/products&#34;,
</span><span style=color:#e6db74>  &#34;vars&#34;: [[&#34;arg_version&#34;, &#34;==&#34;, &#34;v2&#34;]],
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;api-v2:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><h3 id=in-request-headers>In Request Headers<a hidden class=anchor aria-hidden=true href=#in-request-headers>#</a></h3><p>Similar to routing based on query parameters, the below configuration routes requests based on headers. While <code>arg_&lt;argument></code> checks for <code>&lt;argument></code> in the query parameters, <code>http_&lt;header></code> checks for the <code>&lt;header></code> in the request headers:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/products&#34;,
</span><span style=color:#e6db74>  &#34;vars&#34;: [[&#34;http_version&#34;, &#34;==&#34;, &#34;v1&#34;]],
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;api-v1:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/2 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/products&#34;,
</span><span style=color:#e6db74>  &#34;vars&#34;: [[&#34;http_version&#34;, &#34;==&#34;, &#34;v2&#34;]],
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;api-v2:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><p>If you are using the <code>Accept</code> header, you can use the configuration below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/products&#34;,
</span><span style=color:#e6db74>  &#34;vars&#34;: [[&#34;http_accept&#34;, &#34;==&#34;, &#34;application/vnd.shoppingapp.product.v1+json&#34;]],
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;api-v1:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><h2 id=backwards-compatible-apis>Backwards Compatible APIs<a hidden class=anchor aria-hidden=true href=#backwards-compatible-apis>#</a></h2><p>Multiple API versions cannot always get you far and sometimes, change is inevitable. A strategy to make changes to your API without breaking your client applications is to ensure backwards compatibility. i.e., the interface between your clients and the API remains the same while your API changes.</p><p>For example, if you change your API endpoint (from <code>/old/api</code> to <code>/new/api</code>), an API gateway can redirect client requests to the new API endpoint without changes to the client applications.</p><p>APISIX implements this through the <a href="https://apisix.apache.org/docs/apisix/plugins/redirect/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=api-deployment-strategies" target=_blank>redirect</a> and the <a href="https://apisix.apache.org/docs/apisix/plugins/proxy-rewrite/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=api-deployment-strategies" target=_blank>proxy-rewrite</a> plugins. The example below shows how you can configure redirects:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/old/api/products&#34;,
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;redirect&#34;: {
</span><span style=color:#e6db74>      &#34;uri&#34;: &#34;/new/api/products&#34;,
</span><span style=color:#e6db74>      &#34;ret_code&#34;: 301
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><blockquote><p><strong>Note</strong>: Client applications need to be configured to follow redirects for this configuration to work.</p></blockquote><p>There could be more complex scenarios where the client-API interface changes. For instance, if the new API expects the key <code>fullName</code> instead of <code>firstName</code> and <code>lastName</code>, clients sending requests in the old API format would break. APISIX can handle such scenarios through the <a href="https://apisix.apache.org/docs/apisix/plugins/body-transformer/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=api-deployment-strategies" target=_blank>body-transformer</a> plugin.</p><p>The example below shows how APISIX can transform the request body to make your APIs backwards compatible:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/login&#34;,
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;body-transformer&#34;: {
</span><span style=color:#e6db74>      &#34;request&#34;: {
</span><span style=color:#e6db74>        &#34;template&#34;: &#34;{ \&#34;fullName\&#34;: \&#34;{{ firstName }} {{ lastName }}\&#34; }&#34;
</span><span style=color:#e6db74>      }
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;v2:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><p>Now a request body like,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;firstName&#34;</span>: <span style=color:#e6db74>&#34;Navendu&#34;</span>,
  <span style=color:#f92672>&#34;lastName&#34;</span>: <span style=color:#e6db74>&#34;Pottekkat&#34;</span>
}
</code></pre></div><p>will be transformed to:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;fullName&#34;</span>: <span style=color:#e6db74>&#34;Navendu Pottekkat&#34;</span>
}
</code></pre></div><p>Similar transformations at the API gateway level should only be a temporary measure to ensure backwards compatibility as it could add costs in terms of latency or resource use.</p><h2 id=shadow-deployments>Shadow Deployments<a hidden class=anchor aria-hidden=true href=#shadow-deployments>#</a></h2><p>Shadow deployment is a strategy to test new APIs with production traffic. This idea stems from the fact that handwritten test cases might not always simulate every complex real-world scenario.</p><p>Typically, a shadow deployment is carried out by mirroring (sending a copy) production traffic to the new API and ignoring its responses. This lets you test application errors and performance by examining logs and metrics with production traffic without really deploying your new API to production.</p><p>APISIX has a <a href="https://apisix.apache.org/docs/apisix/plugins/proxy-mirror/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=api-deployment-strategies" target=_blank>proxy-mirror</a> plugin that mirrors traffic to another service. The example below shows how you can configure the plugin on a specific route:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/products&#34;,
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;proxy-mirror&#34;: {
</span><span style=color:#e6db74>      &#34;host&#34;: &#34;http://v2:80&#34;
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;v1:80&#34;: 1
</span><span style=color:#e6db74>    },
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><p>Once the plugin is configured, you can examine the logs and metrics from the gateway and your APIs using observability tools like <a href=/posts/introduction-to-monitoring-microservices/>Prometheus</a> or <a href=/posts/apisix-logs-elk/>Elasticsearch</a>.</p><p>A key advantage of shadow deployments is the zero production impact. You can test your APIs with production traffic in a sandboxed test environment. However, you should ensure the test environment is sandboxed and does not send duplicate requests to other production services. This is usually achieved by using mock services.</p><h2 id=canary-deployments>Canary Deployments<a hidden class=anchor aria-hidden=true href=#canary-deployments>#</a></h2><p>A <a href=/posts/canary-in-kubernetes/>canary deployment strategy</a> can be quite helpful when you want to decouple the release of a new API from its deployment.</p><p>In a canary deployment, initially, a small percentage of traffic (say 10%) is routed to the new API version, while the rest remains to be routed to the existing API version. This allows you to test the new API in production for bugs without impacting a lot of your clients. Once the new API is deemed ready, traffic routed to it is gradually increased to 100%.</p><p>APISIX can achieve this routing through the <a href="https://apisix.apache.org/docs/apisix/plugins/traffic-split/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=api-deployment-strategies" target=_blank>traffic-split</a> plugin. The example below shows how you can configure this plugin on a specific route:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/products&#34;,
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;traffic-split&#34;: {
</span><span style=color:#e6db74>      &#34;rules&#34;: [
</span><span style=color:#e6db74>        {
</span><span style=color:#e6db74>          &#34;weighted_upstreams&#34;: [
</span><span style=color:#e6db74>            {
</span><span style=color:#e6db74>              &#34;upstream&#34;: {
</span><span style=color:#e6db74>                &#34;name&#34;: &#34;v1&#34;,
</span><span style=color:#e6db74>                &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>                &#34;nodes&#34;: {
</span><span style=color:#e6db74>                  &#34;v1:80&#34;: 1
</span><span style=color:#e6db74>                }
</span><span style=color:#e6db74>              },
</span><span style=color:#e6db74>              &#34;weight&#34;: 90
</span><span style=color:#e6db74>            },
</span><span style=color:#e6db74>            {
</span><span style=color:#e6db74>              &#34;weight&#34;: 10
</span><span style=color:#e6db74>            }
</span><span style=color:#e6db74>          ]
</span><span style=color:#e6db74>        }
</span><span style=color:#e6db74>      ]
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;v2:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><p>There are similar strategies like blue-green deployments where half of the traffic is routed to one API version, and the other half is routed to the new API version. This can be configured by setting 50-50 weights in the <code>traffic-split</code> plugin:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/routes/1 -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/products&#34;,
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;traffic-split&#34;: {
</span><span style=color:#e6db74>      &#34;rules&#34;: [
</span><span style=color:#e6db74>        {
</span><span style=color:#e6db74>          &#34;weighted_upstreams&#34;: [
</span><span style=color:#e6db74>            {
</span><span style=color:#e6db74>              &#34;upstream&#34;: {
</span><span style=color:#e6db74>                &#34;name&#34;: &#34;v1&#34;,
</span><span style=color:#e6db74>                &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>                &#34;nodes&#34;: {
</span><span style=color:#e6db74>                  &#34;v1:80&#34;: 1
</span><span style=color:#e6db74>                }
</span><span style=color:#e6db74>              },
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#e6db74>              &#34;weight&#34;: 50
</span></span><span style=color:#e6db74>            },
</span><span style=color:#e6db74>            {
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#e6db74>              &#34;weight&#34;: 50
</span></span><span style=color:#e6db74>            }
</span><span style=color:#e6db74>          ]
</span><span style=color:#e6db74>        }
</span><span style=color:#e6db74>      ]
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;v2:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><p>You can also set up A/B testing, a blue-green deployment with more emphasis on testing and experimentation than deploying new API versions. Bobur discusses some of these strategies in detail in <a href="https://api7.ai/blog/api-release-strategies-with-api-gateway?utm_source=navendu_blog&utm_medium=referral&utm_campaign=api-deployment-strategies" target=_blank>this article</a>.</p><h2 id=feature-flags>Feature Flags<a hidden class=anchor aria-hidden=true href=#feature-flags>#</a></h2><p>Sometimes, you want to test new features that do not involve changes to the client-API interface. In such scenarios, running a new API version with this additional feature might require more resources than necessary.</p><p>A simple strategy is configuring feature flags that are dynamic on/off switches in your APIs. An API gateway can act as the feature flag service that all your APIs can listen to decide whether to enable or disable a feature. This works well because the API gateway is already central to your APIs, and there is no need to set up an additional service just to manage the feature flags.</p><p>APISIX can add feature-specific headers to requests from specific client groups, like beta testers using the <code>proxy-rewrite</code> plugin. Your API can then check if this header exists and allow access to new features to these clients without exposing it generally.</p><p>The example below adds a <code>Beta</code> header to clients in the <code>beta_testers</code> consumer group:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9180/apisix/admin/consumer_groups/beta_testers -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;proxy-rewrite&#34;: {
</span><span style=color:#e6db74>      &#34;headers&#34;: {
</span><span style=color:#e6db74>        &#34;set&#34;: {
</span><span style=color:#e6db74>          &#34;Beta&#34;: &#34;true&#34;
</span><span style=color:#e6db74>        }
</span><span style=color:#e6db74>      }
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><h2 id=communication>Communication<a hidden class=anchor aria-hidden=true href=#communication>#</a></h2><p>Communicating with your clients is the most crucial strategy to complement all these strategies. Regardless of which other strategy you pick, communicating it with your clients beforehand can ensure that they are not caught off-guard and have sufficient time to adapt.</p><p>Companies like Google, Facebook, and Twitter, which have a large number of clients using their APIs, have frequently introduced breaking changes to their APIs. However, these companies have ensured that they communicate these changes, provide assistance and documentation to migrate to new API versions, and offer long deprecation periods to ensure clients can transition smoothly.</p><p>The best strategies are often simple.</p><p>To learn more about Apache APISIX, visit <a href="https://apisix.apache.org?utm_source=navendu_blog&utm_medium=referral&utm_campaign=api-deployment-strategies" target=_blank>apisix.apache.org</a>.</p><h2>Related Posts</h2><ul><li><a href=/posts/best-practices-for-building-reliable-apis/>Best Practices for Building Reliable APIs</a></li><li><a href=/posts/apisix-ingress-external/>Accessing External Services through APISIX Ingress</a></li><li><a href=/posts/tinier-apisix-plugin/>A "Tinier" APISIX Plugin</a></li></ul><section class=subscribe-content><hr><p>Thank you for reading <i>"API Deployment Strategies."</i></p><p>Subscribe via <a href=/subscribe>email</a> or
<a href=/index.xml target=_blank>RSS feed</a> to be the first to receive
my content.</p><p>If you liked this post, check out my <a href=/categories/featured>featured posts</a> or learn more <a href=/about>about me</a>.</p></section><section class=subscription-form><form action="https://navendu.us5.list-manage.com/subscribe/post-json?u=fb9ffeb3ee6bc8aaf1d5b8a98&id=5ff8367bc1&c=?" method=post autocomplete=off class=subscribe-form><div class=subscribe-input><input type=email name=EMAIL id=email required placeholder="Email Address ↵" title="Email Address"></div><input value=Subscribe type=submit class=subscribe-button title=Subscribe></form><section class=entry-content><div class=subscribe-message>Get a biweekly dose of tech news, curated content, and uninterrupted musings.</div></section></section><script>$(".subscribe-form").submit(function(d){var a,b,c;d.preventDefault(),a=$(this),b=a.attr("action"),c=a.attr("method"),$.ajax({type:c,url:b,data:a.serialize(),dataType:`jsonp`,success:function(b){b.result===`success`?(a.find(".subscribe-button").attr("value","Subscribed!"),$(".subscribe-message").html("Thank you for subscribing! Check your inbox and add me in your contacts to not miss an issue! <a target='_blank' href='https://twitter.com/intent/tweet?url=https%3A%2F%2Fnavendu.me&text=I%20just%20subscribed%20to%20@sudo_navendu%27s%20blog%21%20Check%20it%20out%21&hashtags=OpenSource%2CDevelopers%2CDEVCommunity'>Tweet about it</a>!"),$(".subscribe-form :input").prop("disabled",!0)):(a.find(".subscribe-button").attr("value","Failed to Subscribe! Click again to retry"),$(".subscribe-message").html("There was an error subscribing you to my blog. "+b.msg+"."),a[0].reset()),console.log(b)},error:function(b){console.log("An error occurred."),console.log(b),a[0].reset()}})})</script></div><footer class=post-footer><ul class=post-tags><li><a href=https://navendu.me/tags/apache-apisix/>apache apisix</a></li><li><a href=https://navendu.me/tags/api-gateway/>api gateway</a></li><li><a href=https://navendu.me/tags/cloud-native/>cloud-native</a></li></ul><nav class=paginav><a class=prev href=https://navendu.me/posts/managing-apisix-declaratively/><span class=title>« Prev</span><br><span>Managing APISIX Declaratively with ADC</span></a>
<a class=next href=https://navendu.me/posts/onos-problems/><span class=title>Next »</span><br><span>One Nation, One Subscription, Many Problems</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on twitter" href="https://twitter.com/intent/tweet/?text=API%20Deployment%20Strategies&url=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f&hashtags=apacheapisix%2capigateway%2ccloud-native"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f&title=API%20Deployment%20Strategies&summary=API%20Deployment%20Strategies&source=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f&title=API%20Deployment%20Strategies"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on whatsapp" href="https://api.whatsapp.com/send?text=API%20Deployment%20Strategies%20-%20https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share API Deployment Strategies on telegram" href="https://telegram.me/share/url?text=API%20Deployment%20Strategies&url=https%3a%2f%2fnavendu.me%2fposts%2fapi-deployment-strategies%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>This work by <a href=https://navendu.me/about/#about-me>Navendu Pottekkat</a></span>
<span>is licensed under <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script><script>for(var els=document.getElementsByClassName("highlight"),i=0,title,code,newNode;i<els.length;i++)title=els[i].title,code=els[i].firstElementChild.firstElementChild,title.length&&(newNode=document.createElement("div"),newNode.textContent=title,newNode.classList.add("highlight-title"),code.parentNode.insertBefore(newNode,code))</script></body></html>