<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Creating a Custom Data Mask Plugin | Navendu Pottekkat</title><meta name=keywords content="apache apisix,api gateway,lua,openresty"><meta name=description content="A tutorial on creating a custom Apache APISIX plugin in Lua through a real use case."><meta name=author content="Zeping Bai, Navendu Pottekkat"><link rel=canonical href=https://apisix.apache.org/blog/2023/07/20/data-mask-plugin/><script defer data-domain=navendu.me src=/misc/js/script.js data-api=/misc/api/event></script><script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><script></script><link crossorigin=anonymous href=/assets/css/stylesheet.66e3e513d75c2ff303648a5691fa6787b3c8f1dc4b3307618713a4dc494f0696.css integrity="sha256-ZuPlE9dcL/MDZIpWkfpnh7PI8dxLMwdhhxOk3ElPBpY=" rel="preload stylesheet" as=style><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://navendu.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://navendu.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://navendu.me/favicon-32x32.png><link rel=apple-touch-icon href=https://navendu.me/apple-touch-icon.png><link rel=mask-icon href=https://navendu.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Creating a Custom Data Mask Plugin"><meta property="og:description" content="A tutorial on creating a custom Apache APISIX plugin in Lua through a real use case."><meta property="og:type" content="article"><meta property="og:url" content="https://navendu.me/posts/data-mask-plugin/"><meta property="og:image" content="https://navendu.me/images/data-mask-plugin/credit-card-banner.jpeg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-21T09:29:55+05:30"><meta property="article:modified_time" content="2023-08-24T22:38:13+05:30"><meta property="og:site_name" content="Navendu Pottekkat"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://navendu.me/images/data-mask-plugin/credit-card-banner.jpeg"><meta name=twitter:title content="Creating a Custom Data Mask Plugin"><meta name=twitter:description content="A tutorial on creating a custom Apache APISIX plugin in Lua through a real use case."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://navendu.me/posts/"},{"@type":"ListItem","position":2,"name":"Creating a Custom Data Mask Plugin","item":"https://navendu.me/posts/data-mask-plugin/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Creating a Custom Data Mask Plugin","name":"Creating a Custom Data Mask Plugin","description":"A tutorial on creating a custom Apache APISIX plugin in Lua through a real use case.","keywords":["apache apisix","api gateway","lua","openresty"],"articleBody":"When talking to one of our users from the fintech industry during the Apache APISIX Community Meetup in Malaysia, we came across a peculiar feature request: mask confidential data in responses.\nFor example, a response from the upstream might contain sensitive data like credit card numbers, and APISIX should be able to replace it with ******* based on some predefined rules.\nCreating such a plugin in Lua might be trivial or daunting, depending on your level of expertise in APISIX+OpenResty+Nginx. So in this article, we will look at how you can create and run this plugin from the ground up while learning some basics of APISIX plugin development in Lua.\nSetting Things Up You can start with the template plugin from apisix-plugin-template. This contains boilerplate code for creating custom Lua plugins for APISIX.\nTo use the template, go to the repository and click “Use this template.” You can then clone it to your local machine for modification.\nUnder the apisix/plugins directory, you will find a file named demo.lua. You can rename this to data-mask.lua. This will be the starting point for our custom plugin.\nInitially, the main parts of the file will look like this containing some boilerplate code which includes some imports and variable definitions:\n-- local common libs local require = require local core = require(\"apisix.core\") -- module define local plugin_name = \"data-mask\" -- plugin schema local plugin_schema = { type = \"object\", properties = {}, required = {}, } local _M = { version = 0.1, -- plugin version priority = 0, -- the priority of this plugin will be 0 name = plugin_name, -- plugin name schema = plugin_schema, -- plugin schema } -- module interface for schema check -- @param `conf` user defined conf data -- @param `schema_type` defined in `apisix/core/schema.lua` -- @return  function _M.check_schema(conf, schema_type) return core.schema.check(plugin_schema, conf) end -- module interface for header_filter phase function _M.header_filter(conf, ctx) end -- module interface for body_filter phase function _M.body_filter(conf, ctx) end return _M There are three functions (interfaces for the plugin) declared on the structure _M:\n check_schema: used for validating the plugin configuration and is called when this plugin is enabled on a route. header_filter and body_filter: for modifying the response header and body, respectively, before sending it to the client.  In the end, this returns _M, and the APISIX can use the data from this to get the metadata and functions from the plugin.\nDesigning the Plugin Like every sound engineer, let’s first design the plugin before we start writing code.\nThe goal of this plugin is simple:\n The user should be able to define what sensitive data would look like in the plugin configuration (maybe RegEx?). They should be able to define what sensitive data should be replaced with (like *******). APISIX should then modify requests and responses based on these configurations.  So each rule can contain a regular expression and a replacement string. This rule will be applied to the response, and the masked data will be returned to the client:\n{ \"rules\": [ { \"regex\": \".*\", \"replace\": \"******\" }, { \"regex\": \".*\", \"replace\": \"**\" } ] } We can now define the JSON schema to validate the plugin configuration. This can help avoid issues with improper plugin configurations during runtime:\nlocal plugin_schema = { type = \"object\", properties = { rules = { type = \"array\", items = { type = \"object\", properties = { regex = { type = \"string\", minLength = 1, }, replace = { type = \"string\", }, }, required = { \"regex\", \"replace\", }, additionalProperties = false, }, minItems = 1, }, }, required = { \"rules\", }, } The rules here is an array of objects meaning you can have multiple rules for defining what sensitive data should look like and what it should be replaced with. Each object in the array contains two required string fields, regex and replace, just like we designed.\nLet’s Write Some Code! We have now decided what the plugin’s functionality would look like and added some JSON schema to validate the plugin’s configuration.\nWe will first modify the _M.header_filter function, which is called before the response header is sent to the client. But why are we changing this? Isn’t our plugin supposed to modify the response body?\nWell, yes. But when we modify the data in the response body (from 2378-4531-5789-1369 to 2378-****-****-1369), the Content-Length header will no longer be accurate. This can cause the client to interpret that the data returned by the server is abnormal and fail to complete the request.\nSince we haven’t modified the request body yet, we cannot calculate the new, accurate value for the Content-Length header. So we need to delete this header value, modify the response body, recalculate the new header value, and set it to the response. To do this in a single sweep, APISIX provides the core.response.clear_header_as_body_modified function:\nfunction _M.header_filter(conf, ctx) core.response.clear_header_as_body_modified() end We can now work on modifying the response body to mask the data. To do this, we must modify the _M.body_filter function.\nSometimes, the upstream response will be sent in chunks (Content-Encoding: chunked), and the body_filter function will be called multiple times. Since each of these chunks are incomplete in itself, we need to cache the data passed each time and call the body_filter function only when all blocks are received and spliced together. And like before, APISIX provides a function, core.response.hold_body_chunk to handle this scenario:\nlocal body = core.response.hold_body_chunk(ctx) if not body then return end Now to mask the response data, we can use the ngx.re.gsub function, which takes in a regular expression and a replacement string and replaces matching strings with the replacement string.\nThe RegEx conforms to the PCRE specification. For example, when the expression is (.*)-(.*)-(.*)-(.*), it will extract the four variables separated by -, and you can use $1, $2, $3, and $4 in the replacement string to refer to the four variables:\nfor _, rule in ipairs(conf.rules) do body = ngx.re.gsub(body, rule.regex, rule.replace, \"jo\") end Finally, to set this as the new response body, we will modify the value of ngx.arg[1] as mentioned in the OpenResty docs. Once we set the value of ngx.arg[2] to true, APISIX will send the new response body to the client:\nngx.arg[1] = body ngx.arg[2] = true Combining all these, the body_filter function will look like this:\nfunction _M.body_filter(conf, ctx) local body = core.response.hold_body_chunk(ctx) if not body then return end for _, rule in ipairs(conf.rules) do body = ngx.re.gsub(body, rule.regex, rule.replace, \"jo\") end ngx.arg[1] = body ngx.arg[2] = true end Now the only thing left to do is glue everything together. The entire plugin code will look like this:\n-- local common libs local require = require local ipairs = ipairs local ngx_re_gsub = ngx.re.gsub local core = require(\"apisix.core\") -- module define local plugin_name = \"data-mask\" -- plugin schema local plugin_schema = { type = \"object\", properties = { rules = { type = \"array\", items = { type = \"object\", properties = { regex = { type = \"string\", minLength = 1, }, replace = { type = \"string\", }, }, required = { \"regex\", \"replace\", }, additionalProperties = false, }, minItems = 1, }, }, required = { \"rules\", }, } local _M = { version = 0.1, -- plugin version priority = 0, -- the priority of this plugin will be 0 name = plugin_name, -- plugin name schema = plugin_schema, -- plugin schema } -- module interface for schema check -- @param `conf` user defined conf data -- @param `schema_type` defined in `apisix/core/schema.lua` -- @return  function _M.check_schema(conf, schema_type) return core.schema.check(plugin_schema, conf) end -- module interface for header_filter phase function _M.header_filter(conf, ctx) core.response.clear_header_as_body_modified() end -- module interface for body_filter phase function _M.body_filter(conf, ctx) local body = core.response.hold_body_chunk(ctx) if not body then return end for _, rule in ipairs(conf.rules) do body = ngx_re_gsub(body, rule.regex, rule.replace, \"jo\") end ngx.arg[1] = body ngx.arg[2] = true end return _M Testing the Plugin Let’s assume our upstream will return a response like this:\n{ \"username\": \"jack\", \"credit_number\": \"2378-4531-5789-1369\" } It contains the username and the credit card number, which is far from ideal. We can use the data-mask plugin to rewrite it to 2378-****-****-1369. The configuration would look like this:\n{ \"rules\": [ { \"regex\": \"\\\"credit_number\\\":\\\"(.*)-(.*)-(.*)-(.*)\\\"\", \"replace\": \"\\\"credit_number\\\":\\\"$1-****-****-$4\\\"\" } ] } A common way the APISIX plugin developers debug plugins by mocking upstream response is through the serverless-pre-function plugin. Through this plugin, you can run custom Lua code, in our case, to send back a response with un-masked credit card numbers:\nreturn function() ngx.header[\"Content-Type\"] = \"application/json\"; require(\"apisix.core\").response.exit(200, { credit_number = \"1234-5678-8765-4321\", username = \"jack\" }) end We can configure both our custom plugin and the serverless-pre-function plugin on the same route as shown below:\ncurl -X PUT 'http://localhost:9180/apisix/admin/routes/data-mask' \\ -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' \\ -H 'Content-Type: application/json' \\ --data '{ \"uri\": \"/data-mask\", \"plugins\": { \"serverless-pre-function\": { \"phase\": \"access\", \"functions\": [ \"return function() ngx.header[\\\"Content-Type\\\"] = \\\"application/json\\\"; require(\\\"apisix.core\\\").response.exit(200, {credit_number = \\\"1234-5678-8765-4321\\\", username = \\\"jack\\\"}) end\" ] }, \"data-mask\": { \"rules\": [ { \"regex\":\"\\\"credit_number\\\":\\\"(.*)-(.*)-(.*)-(.*)\\\"\", \"replace\": \"\\\"credit_number\\\":\\\"$1-****-****-$4\\\"\" } ] } } }' Now if you send a request to the route, you will get back the masked credit card numbers in the response:\ncurl -X GET 'http://localhost:9080/data-mask' { \"username\": \"jack\", \"credit_number\": \"1234-****-****-4321\" } Using in Production You can directly build your own APISIX image with this plugin included for using it in production:\nFROMapache/apisix:3.3.0-debianCOPY ./data-mask.lua /usr/local/apisix/apisix/plugins/data-mask.luaThen run docker build:\ndocker build -t your-own-registry.com/apisix:3.3.0-data-mask . Next, in the configuration file (config.yaml) you can add your plugin to the list:\nplugins: # any other plugins from config-default.yaml - xxxx - data-mask  Note: The values in plugins in the config.yaml file override those in the config-default.yaml file. If you want to use other plugins, copy it to the config.yaml file.\n Once you add it to the configuration file, you should be able to use the plugin on your routes.\nLearn More All the sample code from this article can be found here. You can also use the plugin template to create your own plugins easily.\nAPISIX comes with many in-built plugins; you can refer to its source code for more details on how you can create your own plugins. You can also refer to the lua-nginx-module and this series of OpenResty tutorials to learn more.\n","wordCount":"1700","inLanguage":"en","image":"https://navendu.me/images/data-mask-plugin/credit-card-banner.jpeg","datePublished":"2023-07-21T09:29:55+05:30","dateModified":"2023-08-24T22:38:13+05:30","author":[{"@type":"Person","name":"Zeping Bai"},{"@type":"Person","name":"Navendu Pottekkat"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://navendu.me/posts/data-mask-plugin/"},"publisher":{"@type":"Person","name":"Navendu Pottekkat","logo":{"@type":"ImageObject","url":"https://navendu.me/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://navendu.me/ accesskey=h title="Navendu Pottekkat (Alt + H)">Navendu Pottekkat</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://navendu.me/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://navendu.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://navendu.me/dailies/ title="Daily Logs"><span>Daily Logs</span></a></li><li><a href=https://navendu.me/about/ title=About><span>About</span></a></li><li><a href=https://navendu.me/subscribe/ title=Subscribe><span>Subscribe</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://navendu.me/>Home</a>&nbsp;»&nbsp;<a href=https://navendu.me/posts/>Posts</a></div><h1 class=post-title>Creating a Custom Data Mask Plugin</h1><div class=post-meta><span title="2023-07-21 09:29:55 +0530 +0530">July 21, 2023</span>&nbsp;·&nbsp;8 min&nbsp;|&nbsp;<a href=https://github.com/pottekkat/personal-website/blob/hugo/content/posts/data-mask-plugin.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
&nbsp;|&nbsp;<span>Originally published at&nbsp;<a href=https://apisix.apache.org/blog/2023/07/20/data-mask-plugin/ title=https://apisix.apache.org/blog/2023/07/20/data-mask-plugin/ target=_blank rel="noopener noreferrer">apisix.apache.org</a></span></div></header><figure class=entry-cover><img loading=lazy src=https://navendu.me/images/data-mask-plugin/credit-card-banner.jpeg alt="Photo of a credit card."><p>Photo by <a href=https://www.pexels.com/photo/natwest-atm-card-45111/>Dom J</a></p></figure><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on twitter" href="https://twitter.com/intent/tweet/?text=Creating%20a%20Custom%20Data%20Mask%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f&hashtags=apacheapisix%2capigateway%2clua%2copenresty"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f&title=Creating%20a%20Custom%20Data%20Mask%20Plugin&summary=Creating%20a%20Custom%20Data%20Mask%20Plugin&source=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f&title=Creating%20a%20Custom%20Data%20Mask%20Plugin"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on whatsapp" href="https://api.whatsapp.com/send?text=Creating%20a%20Custom%20Data%20Mask%20Plugin%20-%20https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on telegram" href="https://telegram.me/share/url?text=Creating%20a%20Custom%20Data%20Mask%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><div class=post-content><p>When talking to one of our users from the fintech industry during the <a href="https://www.youtube.com/watch?v=vRwAuvfZIgE?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>Apache APISIX Community Meetup in Malaysia</a>, we came across a peculiar feature request: mask confidential data in responses.</p><p>For example, a response from the upstream might contain sensitive data like credit card numbers, and APISIX should be able to replace it with <code>*******</code> based on some predefined rules.</p><p>Creating such a plugin in Lua might be trivial or daunting, depending on your level of expertise in APISIX+OpenResty+Nginx. So in this article, we will look at how you can create and run this plugin from the ground up while learning some basics of APISIX plugin development in Lua.</p><h2 id=setting-things-up>Setting Things Up<a hidden class=anchor aria-hidden=true href=#setting-things-up>#</a></h2><p>You can start with the template plugin from <a href="https://github.com/api7/apisix-plugin-template?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>apisix-plugin-template</a>. This contains <a href="https://github.com/api7/apisix-plugin-template/blob/main/apisix/plugins/demo.lua?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>boilerplate code</a> for creating custom Lua plugins for APISIX.</p><p>To use the template, go to the repository and click &ldquo;<a href="https://github.com/new?template_name=apisix-plugin-template&template_owner=api7?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>Use this template</a>.&rdquo; You can then clone it to your local machine for modification.</p><p>Under the <a href="https://github.com/api7/apisix-plugin-template/tree/main/apisix/plugins?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>apisix/plugins</a> directory, you will find a file named <code>demo.lua</code>. You can rename this to <code>data-mask.lua</code>. This will be the starting point for our custom plugin.</p><p>Initially, the main parts of the file will look like this containing some boilerplate code which includes some imports and variable definitions:</p><div class=highlight title=data-mask.lua><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#75715e>-- local common libs</span>
<span style=color:#66d9ef>local</span> require <span style=color:#f92672>=</span> require
<span style=color:#66d9ef>local</span> core    <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;apisix.core&#34;</span>)

<span style=color:#75715e>-- module define</span>
<span style=color:#66d9ef>local</span> plugin_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data-mask&#34;</span>

<span style=color:#75715e>-- plugin schema</span>
<span style=color:#66d9ef>local</span> plugin_schema <span style=color:#f92672>=</span> {
    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;object&#34;</span>,
    properties <span style=color:#f92672>=</span> {},
    required <span style=color:#f92672>=</span> {},
}

<span style=color:#66d9ef>local</span> _M <span style=color:#f92672>=</span> {
    version  <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.1</span>,            <span style=color:#75715e>-- plugin version</span>
    priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,              <span style=color:#75715e>-- the priority of this plugin will be 0</span>
    name     <span style=color:#f92672>=</span> plugin_name,    <span style=color:#75715e>-- plugin name</span>
    schema   <span style=color:#f92672>=</span> plugin_schema,  <span style=color:#75715e>-- plugin schema</span>
}


<span style=color:#75715e>-- module interface for schema check</span>
<span style=color:#75715e>-- @param `conf` user defined conf data</span>
<span style=color:#75715e>-- @param `schema_type` defined in `apisix/core/schema.lua`</span>
<span style=color:#75715e>-- @return &lt;boolean&gt;</span>
<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>check_schema</span>(conf, schema_type)
    <span style=color:#66d9ef>return</span> core.schema.check(plugin_schema, conf)
<span style=color:#66d9ef>end</span>


<span style=color:#75715e>-- module interface for header_filter phase</span>
<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>header_filter</span>(conf, ctx)

<span style=color:#66d9ef>end</span>


<span style=color:#75715e>-- module interface for body_filter phase</span>
<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>body_filter</span>(conf, ctx)

<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>return</span> _M
</code></pre></div><p>There are three functions (interfaces for the plugin) declared on the structure <code>_M</code>:</p><ol><li><code>check_schema</code>: used for validating the plugin configuration and is called when this plugin is enabled on a route.</li><li><code>header_filter</code> and</li><li><code>body_filter</code>: for modifying the response header and body, respectively, before sending it to the client.</li></ol><p>In the end, this returns <code>_M</code>, and the APISIX can use the data from this to get the metadata and functions from the plugin.</p><h2 id=designing-the-plugin>Designing the Plugin<a hidden class=anchor aria-hidden=true href=#designing-the-plugin>#</a></h2><p>Like every sound engineer, let&rsquo;s first design the plugin before we start writing code.</p><p>The goal of this plugin is simple:</p><ol><li>The user should be able to define what sensitive data would look like in the plugin configuration (maybe RegEx?).</li><li>They should be able to define what sensitive data should be replaced with (like <code>*******</code>).</li><li>APISIX should then modify requests and responses based on these configurations.</li></ol><p>So each rule can contain a regular expression and a replacement string. This rule will be applied to the response, and the masked data will be returned to the client:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;rules&#34;</span>: [
    {
      <span style=color:#f92672>&#34;regex&#34;</span>: <span style=color:#e6db74>&#34;.*&#34;</span>,
      <span style=color:#f92672>&#34;replace&#34;</span>: <span style=color:#e6db74>&#34;******&#34;</span>
    },
    {
      <span style=color:#f92672>&#34;regex&#34;</span>: <span style=color:#e6db74>&#34;.*&#34;</span>,
      <span style=color:#f92672>&#34;replace&#34;</span>: <span style=color:#e6db74>&#34;**&#34;</span>
    }
  ]
}
</code></pre></div><p>We can now define the JSON schema to validate the plugin configuration. This can help avoid issues with improper plugin configurations during runtime:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#66d9ef>local</span> plugin_schema <span style=color:#f92672>=</span> {
    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;object&#34;</span>,
    properties <span style=color:#f92672>=</span> {
        rules <span style=color:#f92672>=</span> {
            type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;array&#34;</span>,
            items <span style=color:#f92672>=</span> {
                type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;object&#34;</span>,
                properties <span style=color:#f92672>=</span> {
                    regex <span style=color:#f92672>=</span> {
                        type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;string&#34;</span>,
                        minLength <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
                    },
                    replace <span style=color:#f92672>=</span> {
                        type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;string&#34;</span>,
                    },
                },
                required <span style=color:#f92672>=</span> {
                    <span style=color:#e6db74>&#34;regex&#34;</span>,
                    <span style=color:#e6db74>&#34;replace&#34;</span>,
                },
                additionalProperties <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
            },
            minItems <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
        },
    },
    required <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>&#34;rules&#34;</span>,
    },
}
</code></pre></div><p>The <code>rules</code> here is an array of objects meaning you can have multiple rules for defining what sensitive data should look like and what it should be replaced with. Each object in the array contains two required string fields, <code>regex</code> and <code>replace</code>, just like we designed.</p><h2 id=lets-write-some-code>Let&rsquo;s Write Some Code!<a hidden class=anchor aria-hidden=true href=#lets-write-some-code>#</a></h2><p>We have now decided what the plugin&rsquo;s functionality would look like and added some JSON schema to validate the plugin&rsquo;s configuration.</p><p>We will first modify the <code>_M.header_filter</code> function, which is called before the response header is sent to the client. But why are we changing this? Isn&rsquo;t our plugin supposed to modify the response body?</p><p>Well, yes. But when we modify the data in the response body (from <code>2378-4531-5789-1369</code> to <code>2378-****-****-1369</code>), the <code>Content-Length</code> header will no longer be accurate. This can cause the client to interpret that the data returned by the server is abnormal and fail to complete the request.</p><p>Since we haven&rsquo;t modified the request body yet, we cannot calculate the new, accurate value for the <code>Content-Length</code> header.  So we need to delete this header value, modify the response body, recalculate the new header value, and set it to the response. To do this in a single sweep, APISIX provides the <code>core.response.clear_header_as_body_modified</code> function:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>header_filter</span>(conf, ctx)
    core.response.clear_header_as_body_modified()
<span style=color:#66d9ef>end</span>
</code></pre></div><p>We can now work on modifying the response body to mask the data. To do this, we must modify the <code>_M.body_filter</code> function.</p><p>Sometimes, the upstream response will be sent in chunks (<code>Content-Encoding: chunked</code>), and the <code>body_filter</code> function will be called multiple times. Since each of these chunks are incomplete in itself, we need to cache the data passed each time and call the <code>body_filter</code> function only when all blocks are received and spliced together. And like before, APISIX provides a function, <code>core.response.hold_body_chunk</code> to handle this scenario:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#66d9ef>local</span> body <span style=color:#f92672>=</span> core.response.hold_body_chunk(ctx)
<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> body <span style=color:#66d9ef>then</span>
    <span style=color:#66d9ef>return</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Now to mask the response data, we can use the <code>ngx.re.gsub</code> function, which takes in a regular expression and a replacement string and replaces matching strings with the replacement string.</p><p>The RegEx conforms to the PCRE specification. For example, when the expression is <code>(.*)-(.*)-(.*)-(.*)</code>, it will extract the four variables separated by <code>-</code>, and you can use <code>$1</code>, <code>$2</code>, <code>$3</code>, and <code>$4</code> in the replacement string to refer to the four variables:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#66d9ef>for</span> _, rule <span style=color:#66d9ef>in</span> ipairs(conf.rules) <span style=color:#66d9ef>do</span>
    body <span style=color:#f92672>=</span> ngx.re.gsub(body, rule.regex, rule.replace, <span style=color:#e6db74>&#34;jo&#34;</span>)
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Finally, to set this as the new response body, we will modify the value of <code>ngx.arg[1]</code> as mentioned in the <a href="https://github.com/openresty/lua-nginx-module/#body_filter_by_lua_block?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>OpenResty docs</a>. Once we set the value of <code>ngx.arg[2]</code> to <code>true</code>, APISIX will send the new response body to the client:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua>ngx.arg[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> body
ngx.arg[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</code></pre></div><p>Combining all these, the <code>body_filter</code> function will look like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>body_filter</span>(conf, ctx)
    <span style=color:#66d9ef>local</span> body <span style=color:#f92672>=</span> core.response.hold_body_chunk(ctx)
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> body <span style=color:#66d9ef>then</span>
        <span style=color:#66d9ef>return</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#66d9ef>for</span> _, rule <span style=color:#66d9ef>in</span> ipairs(conf.rules) <span style=color:#66d9ef>do</span>
        body <span style=color:#f92672>=</span> ngx.re.gsub(body, rule.regex, rule.replace, <span style=color:#e6db74>&#34;jo&#34;</span>)
    <span style=color:#66d9ef>end</span>

    ngx.arg[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> body
    ngx.arg[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Now the only thing left to do is glue everything together. The entire plugin code will look like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#75715e>-- local common libs</span>
<span style=color:#66d9ef>local</span> require     <span style=color:#f92672>=</span> require
<span style=color:#66d9ef>local</span> ipairs      <span style=color:#f92672>=</span> ipairs
<span style=color:#66d9ef>local</span> ngx_re_gsub <span style=color:#f92672>=</span> ngx.re.gsub
<span style=color:#66d9ef>local</span> core        <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;apisix.core&#34;</span>)

<span style=color:#75715e>-- module define</span>
<span style=color:#66d9ef>local</span> plugin_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data-mask&#34;</span>

<span style=color:#75715e>-- plugin schema</span>
<span style=color:#66d9ef>local</span> plugin_schema <span style=color:#f92672>=</span> {
    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;object&#34;</span>,
    properties <span style=color:#f92672>=</span> {
        rules <span style=color:#f92672>=</span> {
            type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;array&#34;</span>,
            items <span style=color:#f92672>=</span> {
                type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;object&#34;</span>,
                properties <span style=color:#f92672>=</span> {
                    regex <span style=color:#f92672>=</span> {
                        type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;string&#34;</span>,
                        minLength <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
                    },
                    replace <span style=color:#f92672>=</span> {
                        type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;string&#34;</span>,
                    },
                },
                required <span style=color:#f92672>=</span> {
                    <span style=color:#e6db74>&#34;regex&#34;</span>,
                    <span style=color:#e6db74>&#34;replace&#34;</span>,
                },
                additionalProperties <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>,
            },
            minItems <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
        },
    },
    required <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>&#34;rules&#34;</span>,
    },
}

<span style=color:#66d9ef>local</span> _M <span style=color:#f92672>=</span> {
    version  <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.1</span>,            <span style=color:#75715e>-- plugin version</span>
    priority <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,              <span style=color:#75715e>-- the priority of this plugin will be 0</span>
    name     <span style=color:#f92672>=</span> plugin_name,    <span style=color:#75715e>-- plugin name</span>
    schema   <span style=color:#f92672>=</span> plugin_schema,  <span style=color:#75715e>-- plugin schema</span>
}


<span style=color:#75715e>-- module interface for schema check</span>
<span style=color:#75715e>-- @param `conf` user defined conf data</span>
<span style=color:#75715e>-- @param `schema_type` defined in `apisix/core/schema.lua`</span>
<span style=color:#75715e>-- @return &lt;boolean&gt;</span>
<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>check_schema</span>(conf, schema_type)
    <span style=color:#66d9ef>return</span> core.schema.check(plugin_schema, conf)
<span style=color:#66d9ef>end</span>


<span style=color:#75715e>-- module interface for header_filter phase</span>
<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>header_filter</span>(conf, ctx)
    core.response.clear_header_as_body_modified()
<span style=color:#66d9ef>end</span>


<span style=color:#75715e>-- module interface for body_filter phase</span>
<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>body_filter</span>(conf, ctx)
    <span style=color:#66d9ef>local</span> body <span style=color:#f92672>=</span> core.response.hold_body_chunk(ctx)
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> body <span style=color:#66d9ef>then</span>
        <span style=color:#66d9ef>return</span>
    <span style=color:#66d9ef>end</span>

    <span style=color:#66d9ef>for</span> _, rule <span style=color:#66d9ef>in</span> ipairs(conf.rules) <span style=color:#66d9ef>do</span>
        body <span style=color:#f92672>=</span> ngx_re_gsub(body, rule.regex, rule.replace, <span style=color:#e6db74>&#34;jo&#34;</span>)
    <span style=color:#66d9ef>end</span>

    ngx.arg[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> body
    ngx.arg[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
<span style=color:#66d9ef>end</span>

<span style=color:#66d9ef>return</span> _M
</code></pre></div><h2 id=testing-the-plugin>Testing the Plugin<a hidden class=anchor aria-hidden=true href=#testing-the-plugin>#</a></h2><p>Let&rsquo;s assume our upstream will return a response like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;jack&#34;</span>,
  <span style=color:#f92672>&#34;credit_number&#34;</span>: <span style=color:#e6db74>&#34;2378-4531-5789-1369&#34;</span>
}
</code></pre></div><p>It contains the username and the credit card number, which is far from ideal. We can use the <code>data-mask</code> plugin to rewrite it to <code>2378-****-****-1369</code>. The configuration would look like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;rules&#34;</span>: [
    {
      <span style=color:#f92672>&#34;regex&#34;</span>: <span style=color:#e6db74>&#34;\&#34;credit_number\&#34;:\&#34;(.*)-(.*)-(.*)-(.*)\&#34;&#34;</span>,
      <span style=color:#f92672>&#34;replace&#34;</span>: <span style=color:#e6db74>&#34;\&#34;credit_number\&#34;:\&#34;$1-****-****-$4\&#34;&#34;</span>
    }
  ]
}
</code></pre></div><p>A common way the APISIX plugin developers debug plugins by mocking upstream response is through the <a href="https://apisix.apache.org/docs/apisix/plugins/serverless/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>serverless-pre-function</a> plugin. Through this plugin, you can run custom Lua code, in our case, to send back a response with un-masked credit card numbers:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span>()
    ngx.header[<span style=color:#e6db74>&#34;Content-Type&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;application/json&#34;</span>;
    require(<span style=color:#e6db74>&#34;apisix.core&#34;</span>).response.exit(<span style=color:#ae81ff>200</span>, {
        credit_number <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1234-5678-8765-4321&#34;</span>,
        username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jack&#34;</span>
    })
<span style=color:#66d9ef>end</span>
</code></pre></div><p>We can configure both our custom plugin and the <code>serverless-pre-function</code> plugin on the same route as shown below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -X PUT <span style=color:#e6db74>&#39;http://localhost:9180/apisix/admin/routes/data-mask&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>-H <span style=color:#e6db74>&#39;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>-H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--data <span style=color:#e6db74>&#39;{
</span><span style=color:#e6db74>    &#34;uri&#34;: &#34;/data-mask&#34;,
</span><span style=color:#e6db74>    &#34;plugins&#34;: {
</span><span style=color:#e6db74>        &#34;serverless-pre-function&#34;: {
</span><span style=color:#e6db74>            &#34;phase&#34;: &#34;access&#34;,
</span><span style=color:#e6db74>            &#34;functions&#34;: [
</span><span style=color:#e6db74>                &#34;return function() ngx.header[\&#34;Content-Type\&#34;] = \&#34;application/json\&#34;; require(\&#34;apisix.core\&#34;).response.exit(200, {credit_number = \&#34;1234-5678-8765-4321\&#34;, username = \&#34;jack\&#34;}) end&#34;
</span><span style=color:#e6db74>            ]
</span><span style=color:#e6db74>        },
</span><span style=color:#e6db74>        &#34;data-mask&#34;: {
</span><span style=color:#e6db74>            &#34;rules&#34;: [
</span><span style=color:#e6db74>                {
</span><span style=color:#e6db74>                    &#34;regex&#34;:&#34;\&#34;credit_number\&#34;:\&#34;(.*)-(.*)-(.*)-(.*)\&#34;&#34;,
</span><span style=color:#e6db74>                    &#34;replace&#34;: &#34;\&#34;credit_number\&#34;:\&#34;$1-****-****-$4\&#34;&#34;
</span><span style=color:#e6db74>                }
</span><span style=color:#e6db74>            ]
</span><span style=color:#e6db74>        }
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><p>Now if you send a request to the route, you will get back the masked credit card numbers in the response:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -X GET <span style=color:#e6db74>&#39;http://localhost:9080/data-mask&#39;</span>

<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;jack&#34;</span>,
  <span style=color:#e6db74>&#34;credit_number&#34;</span>: <span style=color:#e6db74>&#34;1234-****-****-4321&#34;</span>
<span style=color:#f92672>}</span>
</code></pre></div><h2 id=using-in-production>Using in Production<a hidden class=anchor aria-hidden=true href=#using-in-production>#</a></h2><p>You can directly build your own APISIX image with this plugin included for using it in production:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> apache/apisix:3.3.0-debian</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./data-mask.lua /usr/local/apisix/apisix/plugins/data-mask.lua<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>Then run <code>docker build</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker build -t your-own-registry.com/apisix:3.3.0-data-mask .
</code></pre></div><p>Next, in the configuration file (<code>config.yaml</code>) you can add your plugin to the list:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>plugins</span>:
  <span style=color:#75715e># any other plugins from config-default.yaml</span>
  - <span style=color:#ae81ff>xxxx</span>
  - <span style=color:#ae81ff>data-mask</span>
</code></pre></div><blockquote><p><strong>Note</strong>: The values in <code>plugins</code> in the <code>config.yaml</code> file override those in the <code>config-default.yaml</code> file. If you want to use other plugins, copy it to the <code>config.yaml</code> file.</p></blockquote><p>Once you add it to the configuration file, you should be able to use the plugin on your routes.</p><h2 id=learn-more>Learn More<a hidden class=anchor aria-hidden=true href=#learn-more>#</a></h2><p>All the sample code from this article can be found <a href="https://github.com/bzp2010/apisix-plugin-data-mask/blob/main/apisix/plugins/data-mask.lua?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>here</a>. You can also use the <a href="https://github.com/api7/apisix-plugin-template?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>plugin template</a> to create your own plugins easily.</p><p>APISIX comes with many in-built plugins; you can refer to its <a href="https://github.com/apache/apisix/tree/master/apisix/plugins?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>source code</a> for more details on how you can create your own plugins. You can also refer to the <a href="https://github.com/openresty/lua-nginx-module?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>lua-nginx-module</a> and this <a href="https://api7.ai/learning-center/openresty?utm_source=navendu_blog&utm_medium=referral&utm_campaign=creating-a-custom-data-mask-plugin" target=_blank>series of OpenResty tutorials</a> to learn more.</p><section class=subscribe-content><hr><p>Thank you for reading <i>"Creating a Custom Data Mask Plugin."</i></p><p>Subscribe via <a href=/subscribe>email</a> or
<a href=/index.xml target=_blank>RSS feed</a> to be the first to receive
my content.</p><p>If you liked this post, check out my <a href=/categories/featured>featured posts</a> or learn more <a href=/about>about me</a>.</p></section><section class=subscription-form><form action="https://navendu.us5.list-manage.com/subscribe/post-json?u=fb9ffeb3ee6bc8aaf1d5b8a98&id=5ff8367bc1&c=?" method=post autocomplete=off class=subscribe-form><div class=subscribe-input><input type=email name=EMAIL id=email required placeholder="Email Address ↵" title="Email Address"></div><input value=Subscribe type=submit class=subscribe-button title=Subscribe></form><section class=entry-content><div class=subscribe-message>Get a biweekly dose of tech news, curated content, and uninterrupted musings.</div></section></section><script>$(".subscribe-form").submit(function(d){var a,b,c;d.preventDefault(),a=$(this),b=a.attr("action"),c=a.attr("method"),$.ajax({type:c,url:b,data:a.serialize(),dataType:`jsonp`,success:function(b){b.result===`success`?(a.find(".subscribe-button").attr("value","Subscribed!"),$(".subscribe-message").html("Thank you for subscribing! Check your inbox and add me in your contacts to not miss an issue! <a target='_blank' href='https://twitter.com/intent/tweet?url=https%3A%2F%2Fnavendu.me&text=I%20just%20subscribed%20to%20@sudo_navendu%27s%20blog%21%20Check%20it%20out%21&hashtags=OpenSource%2CDevelopers%2CDEVCommunity'>Tweet about it</a>!"),$(".subscribe-form :input").prop("disabled",!0)):(a.find(".subscribe-button").attr("value","Failed to Subscribe! Click again to retry"),$(".subscribe-message").html("There was an error subscribing you to my blog. "+b.msg+"."),a[0].reset()),console.log(b)},error:function(b){console.log("An error occurred."),console.log(b),a[0].reset()}})})</script></div><footer class=post-footer><ul class=post-tags><li><a href=https://navendu.me/tags/apache-apisix/>apache apisix</a></li><li><a href=https://navendu.me/tags/api-gateway/>api gateway</a></li><li><a href=https://navendu.me/tags/lua/>lua</a></li><li><a href=https://navendu.me/tags/openresty/>openresty</a></li></ul><nav class=paginav><a class=prev href=https://navendu.me/posts/request-validation/><span class=title>« Prev</span><br><span>Your API Requests Should Be Validated</span></a>
<a class=next href=https://navendu.me/posts/regex-grunt-work/><span class=title>Next »</span><br><span>Grunt Work with RegEx</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on twitter" href="https://twitter.com/intent/tweet/?text=Creating%20a%20Custom%20Data%20Mask%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f&hashtags=apacheapisix%2capigateway%2clua%2copenresty"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f&title=Creating%20a%20Custom%20Data%20Mask%20Plugin&summary=Creating%20a%20Custom%20Data%20Mask%20Plugin&source=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f&title=Creating%20a%20Custom%20Data%20Mask%20Plugin"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on whatsapp" href="https://api.whatsapp.com/send?text=Creating%20a%20Custom%20Data%20Mask%20Plugin%20-%20https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Creating a Custom Data Mask Plugin on telegram" href="https://telegram.me/share/url?text=Creating%20a%20Custom%20Data%20Mask%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2fdata-mask-plugin%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>This work by <a href=https://navendu.me/about/#about-me>Navendu Pottekkat</a></span>
<span>is licensed under <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script><script>for(var els=document.getElementsByClassName("highlight"),i=0,title,code,newNode;i<els.length;i++)title=els[i].title,code=els[i].firstElementChild.firstElementChild,title.length&&(newNode=document.createElement("div"),newNode.textContent=title,newNode.classList.add("highlight-title"),code.parentNode.insertBefore(newNode,code))</script></body></html>