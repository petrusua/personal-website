<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A "Tinier" APISIX Plugin | Navendu Pottekkat</title><meta name=keywords content="apache apisix,api gateway,wasm,tutorials"><meta name=description content="Converting the &ldquo;tiny&rdquo; APISIX plugin to a &ldquo;tinier&rdquo; APISIX plugin."><meta name=author content="Navendu Pottekkat"><link rel=canonical href=https://navendu.me/posts/tinier-apisix-plugin/><script defer data-domain=navendu.me src=/misc/js/script.js data-api=/misc/api/event></script><script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><script></script><link crossorigin=anonymous href=/assets/css/stylesheet.66e3e513d75c2ff303648a5691fa6787b3c8f1dc4b3307618713a4dc494f0696.css integrity="sha256-ZuPlE9dcL/MDZIpWkfpnh7PI8dxLMwdhhxOk3ElPBpY=" rel="preload stylesheet" as=style><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://navendu.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://navendu.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://navendu.me/favicon-32x32.png><link rel=apple-touch-icon href=https://navendu.me/apple-touch-icon.png><link rel=mask-icon href=https://navendu.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="A &#34;Tinier&#34; APISIX Plugin"><meta property="og:description" content="Converting the &ldquo;tiny&rdquo; APISIX plugin to a &ldquo;tinier&rdquo; APISIX plugin."><meta property="og:type" content="article"><meta property="og:url" content="https://navendu.me/posts/tinier-apisix-plugin/"><meta property="og:image" content="https://navendu.me/images/tinier-apisix-plugin/tiny-gopher-banner.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-16T09:45:50+05:30"><meta property="article:modified_time" content="2023-10-16T09:44:46+05:30"><meta property="og:site_name" content="Navendu Pottekkat"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://navendu.me/images/tinier-apisix-plugin/tiny-gopher-banner.jpg"><meta name=twitter:title content="A &#34;Tinier&#34; APISIX Plugin"><meta name=twitter:description content="Converting the &ldquo;tiny&rdquo; APISIX plugin to a &ldquo;tinier&rdquo; APISIX plugin."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://navendu.me/posts/"},{"@type":"ListItem","position":2,"name":"A \"Tinier\" APISIX Plugin","item":"https://navendu.me/posts/tinier-apisix-plugin/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A \"Tinier\" APISIX Plugin","name":"A \u0022Tinier\u0022 APISIX Plugin","description":"Converting the \u0026ldquo;tiny\u0026rdquo; APISIX plugin to a \u0026ldquo;tinier\u0026rdquo; APISIX plugin.","keywords":["apache apisix","api gateway","wasm","tutorials"],"articleBody":"In a previous blog post titled “A 'Tiny' APISIX Plugin,” I explored how to write custom Apache APISIX plugins in WebAssembly. I used TinyGo and the Proxy-Wasm specification to write a plugin and compile it into a wasm binary to be run in APISIX.\nHow big is this Wasm binary? Well, let’s check:\nls -lah *.wasm -rwxr-xr-x@ 1 navendu staff 555K Oct 7 17:42 custom_response_header.go.wasm It is not too bad, but reducing the size further would mean faster startup times, reduced memory and storage use, and reduced network latency, which could ultimately reduce costs (financial and otherwise) in constrained environments.\nIn this article, I will explore how we can optimize the size of Wasm binaries and how it corresponds to tradeoffs in performance.\nOptimizing Code A straightforward way to optimize the binary size is by not using external packages. Our plugin uses the fastjson package to parse the data in the request.\nTo reduce the size, we could not use this package and write our own code to parse and work with the data. But this could come with a massive functionality, readability, and maintainability tradeoff.\nSo, although we could cut down the size by removing such external dependencies, the costs of doing so far outweigh the benefits.\nOther than not importing unnecessary packages, you could also reduce the size by using smaller data types, efficient algorithms, and other optimizations in code. This article is less geared towards such optimizations as it could vary across plugins.\nInherent Optimization with TinyGo When the Proxy-Wasm Go SDK was first introduced, the official Go compiler did not support targeting Wasi. This means you can only build Go-Wasm binaries that can run in the browser.\nBut the TinyGo compiler supported Wasi targets. So, it was a natural choice for the SDK to rely on it instead of the official compiler.\nBut recently, the official compiler started supporting Wasi, and you can use it with the SDK to write plugins. Let’s rebuild the binary with the Go compiler now and check its size:\ngo build -o custom_response_header.go.wasm -target=wasi ./main.go ls -lah *.wasm -rwxr-xr-x@ 1 navendu staff 1.5M Oct 12 17:44 custom_response_header.go.wasm That’s almost thrice the size than when using the TinyGo compiler!\nSo, by using the TinyGo compiler, our binaries get optimized by default. This is expected because TinyGo was explicitly made to run Go programs on constrained environments like microcontrollers and other edge devices.\nStripping Debug Symbols A significant chunk of the binary size can be reduced by using certain build flags. One such flag is the -no-debug flag that strips debugging information from the binary.\nIf we add this flag to our build command, it becomes:\ntinygo build -o custom_response_header.go.wasm -no-debug -target=wasi ./main.go Let’s now check the size of the binary and see if it helped:\nls -lah *.wasm -rwxr-xr-x@ 1 navendu staff 191K Oct 12 17:45 custom_response_header.go.wasm That’s a considerable change! The size of the binary went from 555 kB to 191 kB with just this flag.\nFor most production environments, the cost of being unable to work with a debugger is insignificant. So, this flag can significantly reduce the binary size without much tradeoffs.\nNot Printing Panic Messages Similar to the -no-debug flag, using the -panic=trap flag cuts down the binary size but makes debugging harder. Using this flag will result in panic messages not being printed, which could be an okay tradeoff in production environments.\nWe can add this flag to our build command:\ntinygo build -o custom_response_header.go.wasm -no-debug -panic=trap -target=wasi ./main.go The binary should now be smaller:\nls -lah *.wasm -rwxr-xr-x@ 1 navendu staff 177K Oct 12 17:48 custom_response_header.go.wasm And it is smaller, although not by that much.\nUsing a Leaky Garbage Collector A garbage collector is responsible for freeing up memory that is no longer in use. With the -gc=leaking flag, we can override the default garbage collector used in TinyGo with a leaky garbage collector that—if it is not yet evident—leaks memory.\nAlthough memory leaks can be problematic in many scenarios, they might help improve the performance of the Wasm plugins in APISIX.\nFor each request, APISIX creates a new instance of the Wasm plugin, running it in a separate context. So unless your plugin allocates a large amount of memory for each request or handles a large volume of concurrent requests, you won’t run into any noticeable memory issues. The allocated memory would be freed as the context associated with the request is destroyed.\nAdding this flag, our build command becomes:\ntinygo build -o custom_response_header.go.wasm -no-debug -panic=trap -gc=leaking -target=wasi ./main.go Does this reduce the size of the Wasm binary? Let’s find out:\nls -lah *.wasm -rwxr-xr-x@ 1 navendu staff 143K Oct 12 17:51 custom_response_header.go.wasm The change in size is small. However, using a leaky garbage collector can significantly improve the plugin’s performance, which is good.\n Note: If you are unsure if using a leaky garbage collector is okay, run a significant number of tests before using it in production. Or, just use the default garbage collector if the costs of running into potential memory issues don’t tip the scales for the potential benefits.\n Disabling Goroutines Disabling goroutines can also reduce the size of the final binary. Since our plugin does not leverage Go’s concurrency features, we can set the -scheduler=none flag to disable it.\nThe build command is getting pretty long now:\ntinygo build -o custom_response_header.go.wasm -no-debug -panic=trap -gc=leaking -scheduler=none -target=wasi ./main.go This won’t optimize it further than 168 kB now, right? Let’s build the binary and check its size:\nls -lah *.wasm -rwxr-xr-x@ 1 navendu staff 89K Oct 12 17:54 custom_response_header.go.wasm The size is reduced by around 40%! But could it be any smaller?\nTrading Speed for Size The final build flag I wanted to explore was the -opt flag that controls the level of optimization applied by the compiler.\nBy default, TinyGo uses -opt=z, which optimizes for size. However, there are other options available to change this optimization level. The TinyGo documentation suggests using -opt=2 for performance if you are not trying to limit the size and using -opt=s for a more balanced approach between speed and size.\nSince we are optimizing for size, we will keep it as it is.\nUsing Binaryen Toolkit wasm-opt is a tool part of the Binaryen toolkit, a compiler infrastructure library for Wasm. It takes a Wasm binary and applies a series of optimizations (dead code elimination, precomputing expressions, etc.) to improve its performance and/or reduce its size.\nAs we saw above, using build flags significantly reduced the size of Wasm binaries produced. Using wasm-opt on these binaries would reduce their sizes even more. Running wasm-opt with the -O flag applies the default optimizations to the binary:\nwasm-opt -O custom_response_header.go.wasm -o custom_response_header.go.wasm Now let’s check how effective the default optimizations are:\nls -lah *.wasm -rwxr-xr-x@ 1 navendu staff 84K Oct 12 17:58 custom_response_header.go.wasm It’s not much, but we can change this default behavior and trade size for speed, as we saw with the build flags. This is done through the -O1 to -04 flags, which execute one to four optimization passes, and the -Os flag, a less aggressive version of -Oz.\nThere is no one-size-fits-all configuration, and most documentation I’ve looked through suggests a trial-and-error method to see what works best for you. wasm-opt has even more configuration options, which you can fine-tune, but it can also be overwhelming (try wasm-opt --help) depending on your goal. I will leave it at the default optimizations for now.\nBalancing Tradeoffs We started off with a 555 kB binary and ended up with an 84 kB one. That’s a decrease in size by 84%! If you count the 1.5 MB binary built using the official Go compiler, this becomes closer to 95%.\nAs impressive as this is, it is also important to note the tradeoffs we made along the way. The right way to make decisions here is in terms of costs and benefits rather than an absolute optimal solution.\nOther tools like wasm-objdump from the WebAssembly Binary Toolkit and Twiggy can analyze the size of Wasm binaries to make better decisions. During my tests, Twiggy did not work with Wasm binaries compiled using TinyGo, although it is the better tool. I understand this because Twiggy works by parsing the Wasm binary, and the parser does not support the binaries generated by TinyGo.\nAPISIX plans to strengthen its support for Wasm plugins in the future. With a more or less on-par performance to native Lua plugins, improving this support would make it easy for development teams to adopt APISIX.\n","wordCount":"1418","inLanguage":"en","image":"https://navendu.me/images/tinier-apisix-plugin/tiny-gopher-banner.jpg","datePublished":"2023-10-16T09:45:50+05:30","dateModified":"2023-10-16T09:44:46+05:30","author":{"@type":"Person","name":"Navendu Pottekkat"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://navendu.me/posts/tinier-apisix-plugin/"},"publisher":{"@type":"Person","name":"Navendu Pottekkat","logo":{"@type":"ImageObject","url":"https://navendu.me/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://navendu.me/ accesskey=h title="Navendu Pottekkat (Alt + H)">Navendu Pottekkat</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://navendu.me/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://navendu.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://navendu.me/dailies/ title="Daily Logs"><span>Daily Logs</span></a></li><li><a href=https://navendu.me/about/ title=About><span>About</span></a></li><li><a href=https://navendu.me/subscribe/ title=Subscribe><span>Subscribe</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://navendu.me/>Home</a>&nbsp;»&nbsp;<a href=https://navendu.me/posts/>Posts</a></div><h1 class=post-title>A "Tinier" APISIX Plugin</h1><div class=post-meta><span title="2023-10-16 09:45:50 +0530 +0530">October 16, 2023</span>&nbsp;·&nbsp;7 min&nbsp;|&nbsp;<a href=https://github.com/pottekkat/personal-website/blob/hugo/content/posts/tinier-apisix-plugin.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://navendu.me/images/tinier-apisix-plugin/tiny-gopher-banner.jpg alt="A tiny gopher."><p>Using some magic to reduce the size of the Wasm binary.</p></figure><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on twitter' href="https://twitter.com/intent/tweet/?text=A%20%22Tinier%22%20APISIX%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f&hashtags=apacheapisix%2capigateway%2cwasm%2ctutorials"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on linkedin' href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f&title=A%20%22Tinier%22%20APISIX%20Plugin&summary=A%20%22Tinier%22%20APISIX%20Plugin&source=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on reddit' href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f&title=A%20%22Tinier%22%20APISIX%20Plugin"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on facebook' href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on whatsapp' href="https://api.whatsapp.com/send?text=A%20%22Tinier%22%20APISIX%20Plugin%20-%20https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on telegram' href="https://telegram.me/share/url?text=A%20%22Tinier%22%20APISIX%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#optimizing-code aria-label="Optimizing Code">Optimizing Code</a></li><li><a href=#inherent-optimization-with-tinygo aria-label="Inherent Optimization with TinyGo">Inherent Optimization with TinyGo</a></li><li><a href=#stripping-debug-symbols aria-label="Stripping Debug Symbols">Stripping Debug Symbols</a></li><li><a href=#not-printing-panic-messages aria-label="Not Printing Panic Messages">Not Printing Panic Messages</a></li><li><a href=#using-a-leaky-garbage-collector aria-label="Using a Leaky Garbage Collector">Using a Leaky Garbage Collector</a></li><li><a href=#disabling-goroutines aria-label="Disabling Goroutines">Disabling Goroutines</a></li><li><a href=#trading-speed-for-size aria-label="Trading Speed for Size">Trading Speed for Size</a></li><li><a href=#using-binaryen-toolkit aria-label="Using Binaryen Toolkit">Using Binaryen Toolkit</a></li><li><a href=#balancing-tradeoffs aria-label="Balancing Tradeoffs">Balancing Tradeoffs</a></li></ul></div></details></div><div class=post-content><p>In a previous blog post titled &ldquo;<a href=/posts/tiny-apisix-plugin/>A 'Tiny' APISIX Plugin</a>,&rdquo; I explored how to write custom Apache APISIX plugins in WebAssembly. I used TinyGo and the <a href="https://github.com/proxy-wasm/spec?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tinier-apisix-plugin" target=_blank>Proxy-Wasm specification</a> to write a plugin and compile it into a wasm binary to be run in APISIX.</p><p>How big is this Wasm binary? Well, let&rsquo;s check:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ls -lah *.wasm
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>-rwxr-xr-x@ <span style=color:#ae81ff>1</span> navendu  staff   555K Oct  <span style=color:#ae81ff>7</span> 17:42 custom_response_header.go.wasm
</code></pre></div><p>It is not too bad, but reducing the size further would mean faster startup times, reduced memory and storage use, and reduced network latency, which could ultimately reduce costs (financial and otherwise) in constrained environments.</p><p>In this article, I will explore how we can optimize the size of Wasm binaries and how it corresponds to tradeoffs in performance.</p><h2 id=optimizing-code>Optimizing Code<a hidden class=anchor aria-hidden=true href=#optimizing-code>#</a></h2><p>A straightforward way to optimize the binary size is by not using external packages. Our plugin <a href=/posts/tiny-apisix-plugin/#a-tiny-go-plugin>uses</a> the <a href="https://github.com/valyala/fastjson?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tinier-apisix-plugin" target=_blank>fastjson</a> package to parse the data in the request.</p><p>To reduce the size, we could not use this package and write our own code to parse and work with the data. But this could come with a massive functionality, readability, and maintainability tradeoff.</p><p>So, although we could cut down the size by removing such external dependencies, the costs of doing so far outweigh the benefits.</p><p>Other than not importing unnecessary packages, you could also reduce the size by using smaller data types, efficient algorithms, and other optimizations in code. This article is less geared towards such optimizations as it could vary across plugins.</p><h2 id=inherent-optimization-with-tinygo>Inherent Optimization with TinyGo<a hidden class=anchor aria-hidden=true href=#inherent-optimization-with-tinygo>#</a></h2><p>When the <a href="https://github.com/tetratelabs/proxy-wasm-go-sdk?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tinier-apisix-plugin" target=_blank>Proxy-Wasm Go SDK</a> was first introduced, the official Go compiler did not support targeting Wasi. This means you can only build Go-Wasm binaries that can run in the browser.</p><p>But the TinyGo compiler supported Wasi targets. So, it was a <a href="https://github.com/tetratelabs/proxy-wasm-go-sdk/blob/main/doc/OVERVIEW.md#tinygo-vs-the-official-go-compiler?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tinier-apisix-plugin" target=_blank>natural choice</a> for the SDK to rely on it instead of the official compiler.</p><p>But recently, the official compiler started supporting Wasi, and you can use it with the SDK to write plugins. Let&rsquo;s rebuild the binary with the Go compiler now and check its size:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>go build -o custom_response_header.go.wasm -target<span style=color:#f92672>=</span>wasi ./main.go
ls -lah *.wasm
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>-rwxr-xr-x@ <span style=color:#ae81ff>1</span> navendu  staff   1.5M Oct <span style=color:#ae81ff>12</span> 17:44 custom_response_header.go.wasm
</code></pre></div><p>That&rsquo;s almost thrice the size than when using the TinyGo compiler!</p><p>So, by using the TinyGo compiler, our binaries get optimized by default. This is expected because TinyGo was explicitly made to run Go programs on constrained environments like microcontrollers and other edge devices.</p><h2 id=stripping-debug-symbols>Stripping Debug Symbols<a hidden class=anchor aria-hidden=true href=#stripping-debug-symbols>#</a></h2><p>A significant chunk of the binary size can be reduced by using certain build flags. One such flag is the <code>-no-debug</code> flag that strips debugging information from the binary.</p><p>If we add this flag to our build command, it becomes:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>tinygo build -o custom_response_header.go.wasm -no-debug -target<span style=color:#f92672>=</span>wasi ./main.go
</code></pre></div><p>Let&rsquo;s now check the size of the binary and see if it helped:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ls -lah *.wasm
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>-rwxr-xr-x@ <span style=color:#ae81ff>1</span> navendu  staff   191K Oct <span style=color:#ae81ff>12</span> 17:45 custom_response_header.go.wasm
</code></pre></div><p>That&rsquo;s a considerable change! The size of the binary went from 555 kB to 191 kB with just this flag.</p><p>For most production environments, the cost of being unable to work with a debugger is insignificant. So, this flag can significantly reduce the binary size without much tradeoffs.</p><h2 id=not-printing-panic-messages>Not Printing Panic Messages<a hidden class=anchor aria-hidden=true href=#not-printing-panic-messages>#</a></h2><p>Similar to the <code>-no-debug</code> flag, using the <code>-panic=trap</code> flag cuts down the binary size but makes debugging harder. Using this flag will result in panic messages not being printed, which could be an okay tradeoff in production environments.</p><p>We can add this flag to our build command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>tinygo build -o custom_response_header.go.wasm -no-debug -panic<span style=color:#f92672>=</span>trap -target<span style=color:#f92672>=</span>wasi ./main.go
</code></pre></div><p>The binary should now be smaller:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ls -lah *.wasm
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>-rwxr-xr-x@ <span style=color:#ae81ff>1</span> navendu  staff   177K Oct <span style=color:#ae81ff>12</span> 17:48 custom_response_header.go.wasm
</code></pre></div><p>And it is smaller, although not by that much.</p><h2 id=using-a-leaky-garbage-collector>Using a Leaky Garbage Collector<a hidden class=anchor aria-hidden=true href=#using-a-leaky-garbage-collector>#</a></h2><p>A garbage collector is responsible for freeing up memory that is no longer in use. With the <code>-gc=leaking</code> flag, we can override the default garbage collector used in TinyGo with a leaky garbage collector that—if it is not yet evident—leaks memory.</p><p>Although memory leaks can be problematic in many scenarios, they might help improve the performance of the Wasm plugins in APISIX.</p><p>For each request, APISIX creates a new instance of the Wasm plugin, running it in a separate context. So unless your plugin allocates a large amount of memory for each request or handles a large volume of concurrent requests, you won&rsquo;t run into any noticeable memory issues. The allocated memory would be freed as the context associated with the request is destroyed.</p><p>Adding this flag, our build command becomes:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>tinygo build -o custom_response_header.go.wasm -no-debug -panic<span style=color:#f92672>=</span>trap -gc<span style=color:#f92672>=</span>leaking -target<span style=color:#f92672>=</span>wasi ./main.go
</code></pre></div><p>Does this reduce the size of the Wasm binary? Let&rsquo;s find out:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ls -lah *.wasm
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>-rwxr-xr-x@ <span style=color:#ae81ff>1</span> navendu  staff   143K Oct <span style=color:#ae81ff>12</span> 17:51 custom_response_header.go.wasm
</code></pre></div><p>The change in size is small. However, using a leaky garbage collector can significantly improve the plugin&rsquo;s performance, which is good.</p><blockquote><p><strong>Note</strong>: If you are unsure if using a leaky garbage collector is okay, run a significant number of tests before using it in production. Or, just use the default garbage collector if the costs of running into potential memory issues don&rsquo;t tip the scales for the potential benefits.</p></blockquote><h2 id=disabling-goroutines>Disabling Goroutines<a hidden class=anchor aria-hidden=true href=#disabling-goroutines>#</a></h2><p>Disabling goroutines can also reduce the size of the final binary. Since our plugin does not leverage Go&rsquo;s concurrency features, we can set the <code>-scheduler=none</code> flag to disable it.</p><p>The build command is getting pretty long now:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>tinygo build -o custom_response_header.go.wasm -no-debug -panic<span style=color:#f92672>=</span>trap -gc<span style=color:#f92672>=</span>leaking -scheduler<span style=color:#f92672>=</span>none -target<span style=color:#f92672>=</span>wasi ./main.go
</code></pre></div><p>This won&rsquo;t optimize it further than 168 kB now, right? Let&rsquo;s build the binary and check its size:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ls -lah *.wasm
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>-rwxr-xr-x@ <span style=color:#ae81ff>1</span> navendu  staff    89K Oct <span style=color:#ae81ff>12</span> 17:54 custom_response_header.go.wasm
</code></pre></div><p>The size is reduced by around 40%! But could it <em>be</em> any smaller?</p><h2 id=trading-speed-for-size>Trading Speed for Size<a hidden class=anchor aria-hidden=true href=#trading-speed-for-size>#</a></h2><p>The final build flag I wanted to explore was the <code>-opt</code> flag that controls the level of optimization applied by the compiler.</p><p>By default, TinyGo uses <code>-opt=z</code>, which optimizes for size. However, there are other options available to change this optimization level. The <a href="https://tinygo.org/docs/reference/usage/important-options/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tinier-apisix-plugin" target=_blank>TinyGo documentation</a> suggests using <code>-opt=2</code> for performance if you are not trying to limit the size and using <code>-opt=s</code> for a more balanced approach between speed and size.</p><p>Since we are optimizing for size, we will keep it as it is.</p><h2 id=using-binaryen-toolkit>Using Binaryen Toolkit<a hidden class=anchor aria-hidden=true href=#using-binaryen-toolkit>#</a></h2><p><code>wasm-opt</code> is a tool part of the Binaryen toolkit, a compiler infrastructure library for Wasm. It takes a Wasm binary and applies a series of optimizations (dead code elimination, precomputing expressions, etc.) to improve its performance and/or reduce its size.</p><p>As we saw above, using build flags significantly reduced the size of Wasm binaries produced. Using <code>wasm-opt</code> on these binaries would reduce their sizes even more. Running <code>wasm-opt</code> with the <code>-O</code> flag applies the default optimizations to the binary:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>wasm-opt -O custom_response_header.go.wasm -o custom_response_header.go.wasm
</code></pre></div><p>Now let&rsquo;s check how effective the default optimizations are:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ls -lah *.wasm
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>-rwxr-xr-x@ <span style=color:#ae81ff>1</span> navendu  staff    84K Oct <span style=color:#ae81ff>12</span> 17:58 custom_response_header.go.wasm
</code></pre></div><p>It&rsquo;s not much, but we can change this default behavior and trade size for speed, as we saw with the build flags. This is done through the <code>-O1</code> to <code>-04</code> flags, which execute one to four optimization passes, and the <code>-Os</code> flag, a less aggressive version of <code>-Oz</code>.</p><p>There is no one-size-fits-all configuration, and most documentation I&rsquo;ve looked through suggests a trial-and-error method to see what works best for you. <code>wasm-opt</code> has even more configuration options, which you can fine-tune, but it can also be overwhelming (try <code>wasm-opt --help</code>) depending on your goal. I will leave it at the default optimizations for now.</p><h2 id=balancing-tradeoffs>Balancing Tradeoffs<a hidden class=anchor aria-hidden=true href=#balancing-tradeoffs>#</a></h2><p>We started off with a 555 kB binary and ended up with an 84 kB one. That&rsquo;s a decrease in size by 84%! If you count the 1.5 MB binary built using the official Go compiler, this becomes closer to 95%.</p><p>As impressive as this is, it is also important to note the tradeoffs we made along the way. The right way to make decisions here is in terms of costs and benefits rather than an absolute optimal solution.</p><p>Other tools like <code>wasm-objdump</code> from the <a href="https://github.com/WebAssembly/wabt?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tinier-apisix-plugin" target=_blank>WebAssembly Binary Toolkit</a> and <a href="https://github.com/rustwasm/twiggy?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tinier-apisix-plugin" target=_blank>Twiggy</a> can analyze the size of Wasm binaries to make better decisions. During my tests, Twiggy did not work with Wasm binaries compiled using TinyGo, although it is the better tool. I understand this because Twiggy works by parsing the Wasm binary, and the parser does not support the binaries generated by TinyGo.</p><p>APISIX plans to strengthen <a href="https://api7.ai/blog/how-apisix-supports-wasm?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tinier-apisix-plugin" target=_blank>its support for Wasm plugins</a> in the future. With a more or less <a href=/posts/tiny-apisix-plugin/#wasm-for-the-win>on-par performance</a> to native Lua plugins, improving this support would make it easy for development teams to adopt APISIX.</p><section class=subscribe-content><hr><p>Thank you for reading <i>"A "Tinier" APISIX Plugin."</i></p><p>Subscribe via <a href=/subscribe>email</a> or
<a href=/index.xml target=_blank>RSS feed</a> to be the first to receive
my content.</p><p>If you liked this post, check out my <a href=/categories/featured>featured posts</a> or learn more <a href=/about>about me</a>.</p></section><section class=subscription-form><form action="https://navendu.us5.list-manage.com/subscribe/post-json?u=fb9ffeb3ee6bc8aaf1d5b8a98&id=5ff8367bc1&c=?" method=post autocomplete=off class=subscribe-form><div class=subscribe-input><input type=email name=EMAIL id=email required placeholder="Email Address ↵" title="Email Address"></div><input value=Subscribe type=submit class=subscribe-button title=Subscribe></form><section class=entry-content><div class=subscribe-message>Get a biweekly dose of tech news, curated content, and uninterrupted musings.</div></section></section><script>$(".subscribe-form").submit(function(d){var a,b,c;d.preventDefault(),a=$(this),b=a.attr("action"),c=a.attr("method"),$.ajax({type:c,url:b,data:a.serialize(),dataType:`jsonp`,success:function(b){b.result===`success`?(a.find(".subscribe-button").attr("value","Subscribed!"),$(".subscribe-message").html("Thank you for subscribing! Check your inbox and add me in your contacts to not miss an issue! <a target='_blank' href='https://twitter.com/intent/tweet?url=https%3A%2F%2Fnavendu.me&text=I%20just%20subscribed%20to%20@sudo_navendu%27s%20blog%21%20Check%20it%20out%21&hashtags=OpenSource%2CDevelopers%2CDEVCommunity'>Tweet about it</a>!"),$(".subscribe-form :input").prop("disabled",!0)):(a.find(".subscribe-button").attr("value","Failed to Subscribe! Click again to retry"),$(".subscribe-message").html("There was an error subscribing you to my blog. "+b.msg+"."),a[0].reset()),console.log(b)},error:function(b){console.log("An error occurred."),console.log(b),a[0].reset()}})})</script></div><footer class=post-footer><ul class=post-tags><li><a href=https://navendu.me/tags/apache-apisix/>apache apisix</a></li><li><a href=https://navendu.me/tags/api-gateway/>api gateway</a></li><li><a href=https://navendu.me/tags/wasm/>wasm</a></li><li><a href=https://navendu.me/tags/tutorials/>tutorials</a></li></ul><nav class=paginav><a class=prev href=https://navendu.me/posts/e2e-iterate/><span class=title>« Prev</span><br><span>End to End, Iterate</span></a>
<a class=next href=https://navendu.me/posts/shallow-wasm-waters/><span class=title>Next »</span><br><span>Shallow WebAssembly Waters</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on twitter' href="https://twitter.com/intent/tweet/?text=A%20%22Tinier%22%20APISIX%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f&hashtags=apacheapisix%2capigateway%2cwasm%2ctutorials"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on linkedin' href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f&title=A%20%22Tinier%22%20APISIX%20Plugin&summary=A%20%22Tinier%22%20APISIX%20Plugin&source=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on reddit' href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f&title=A%20%22Tinier%22%20APISIX%20Plugin"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on facebook' href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on whatsapp' href="https://api.whatsapp.com/send?text=A%20%22Tinier%22%20APISIX%20Plugin%20-%20https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tinier" APISIX Plugin on telegram' href="https://telegram.me/share/url?text=A%20%22Tinier%22%20APISIX%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2ftinier-apisix-plugin%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>This work by <a href=https://navendu.me/about/#about-me>Navendu Pottekkat</a></span>
<span>is licensed under <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script><script>for(var els=document.getElementsByClassName("highlight"),i=0,title,code,newNode;i<els.length;i++)title=els[i].title,code=els[i].firstElementChild.firstElementChild,title.length&&(newNode=document.createElement("div"),newNode.textContent=title,newNode.classList.add("highlight-title"),code.parentNode.insertBefore(newNode,code))</script></body></html>