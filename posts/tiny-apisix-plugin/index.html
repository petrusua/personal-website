<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>A "Tiny" APISIX Plugin | Navendu Pottekkat</title><meta name=keywords content="apache apisix,api gateway,wasm,tutorials"><meta name=description content="A &ldquo;tiny&rdquo; example to demonstrate how Apache APISIX supports Wasm plugins."><meta name=author content="Navendu Pottekkat"><link rel=canonical href=https://navendu.me/posts/tiny-apisix-plugin/><script defer data-domain=navendu.me src=/misc/js/script.js data-api=/misc/api/event></script><script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><script></script><link crossorigin=anonymous href=/assets/css/stylesheet.66e3e513d75c2ff303648a5691fa6787b3c8f1dc4b3307618713a4dc494f0696.css integrity="sha256-ZuPlE9dcL/MDZIpWkfpnh7PI8dxLMwdhhxOk3ElPBpY=" rel="preload stylesheet" as=style><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://navendu.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://navendu.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://navendu.me/favicon-32x32.png><link rel=apple-touch-icon href=https://navendu.me/apple-touch-icon.png><link rel=mask-icon href=https://navendu.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="A &#34;Tiny&#34; APISIX Plugin"><meta property="og:description" content="A &ldquo;tiny&rdquo; example to demonstrate how Apache APISIX supports Wasm plugins."><meta property="og:type" content="article"><meta property="og:url" content="https://navendu.me/posts/tiny-apisix-plugin/"><meta property="og:image" content="https://navendu.me/images/tiny-apisix-plugin/gopher-banner.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-07T09:40:14+05:30"><meta property="article:modified_time" content="2023-10-12T15:48:14+05:30"><meta property="og:site_name" content="Navendu Pottekkat"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://navendu.me/images/tiny-apisix-plugin/gopher-banner.jpg"><meta name=twitter:title content="A &#34;Tiny&#34; APISIX Plugin"><meta name=twitter:description content="A &ldquo;tiny&rdquo; example to demonstrate how Apache APISIX supports Wasm plugins."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://navendu.me/posts/"},{"@type":"ListItem","position":2,"name":"A \"Tiny\" APISIX Plugin","item":"https://navendu.me/posts/tiny-apisix-plugin/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"A \"Tiny\" APISIX Plugin","name":"A \u0022Tiny\u0022 APISIX Plugin","description":"A \u0026ldquo;tiny\u0026rdquo; example to demonstrate how Apache APISIX supports Wasm plugins.","keywords":["apache apisix","api gateway","wasm","tutorials"],"articleBody":"A key feature of Apache APISIX is its pluggable architecture. In addition to providing 80+ Lua plugins out of the box, APISIX also supports external plugins written in other languages through plugin runners and WebAssembly (Wasm).\nIn this article, we will write a “tiny” Go plugin for APISIX, compile it to a Wasm binary, run it in APISIX, and learn how it all works. We will also compare the benefits and costs of using Wasm plugins, external plugins (plugin runners), and native Lua plugins.\nAPISIX and Wasm APISIX supports Wasm through the WebAssembly for Proxies (proxy-wasm) specification. APISIX is a host environment that implements the specification, and developers can use the SDKs available in multiple languages to create plugins.\nUsing Wasm plugins in APISIX has multiple advantages:\n Many programming languages compile to Wasm. This allows you to leverage the capabilities of your tech stack in APISIX plugins. The plugins run inside APISIX and not on external plugin runners. This means you compromise less on performance while writing external plugins. Wasm plugins run inside APISIX but in a separate VM. So even if the plugin crashes, APISIX can continue to run. APISIX can only maintain its Wasm support without having to maintain plugin runners for multiple languages*.  * These advantages come with a set of caveats which we will look at later.\nAPISIX’s plugin architecture below shows native Lua plugins, external plugins through plugin runners, and Wasm plugins:\n Lua plugins, plugin runners, and Wasm plugins   A “Tiny” Go Plugin Let’s get coding! To write a Go plugin, we will use the proxy-wasm-go-sdk.\nReading through the documentation, you will understand why this plugin is called “tiny,” i.e., the SDK uses the TinyGo compiler instead of the official Go compiler. You can read more about why this is the case on the SDK's overview page, but the TLDR version is that the Go compiler can only produce Wasm binaries that run in the browser.\nFor our example, we will create a plugin that adds a response header. The code below is pretty self-explanatory, and you can refer to other plugins for more implementation details:\n// references: // https://github.com/tetratelabs/proxy-wasm-go-sdk/tree/main/examples // https://github.com/apache/apisix/blob/master/t/wasm/ package main import ( \"github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm\" \"github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types\" \"github.com/valyala/fastjson\" ) func main() { proxywasm.SetVMContext(\u0026vmContext{}) } // each plugin has its own VMContext. // it is responsible for creating multiple PluginContexts for each route. type vmContext struct { types.DefaultVMContext } // each route has its own PluginContext. // it corresponds to one instance of the plugin. func (*vmContext) NewPluginContext(contextID uint32) types.PluginContext { return \u0026pluginContext{} } type header struct { Name string Value string } type pluginContext struct { types.DefaultPluginContext Headers []header } func (ctx *pluginContext) OnPluginStart(pluginConfigurationSize int) types.OnPluginStartStatus { data, err := proxywasm.GetPluginConfiguration() if err != nil { proxywasm.LogErrorf(\"error reading plugin configuration: %v\", err) return types.OnPluginStartStatusFailed } var p fastjson.Parser v, err := p.ParseBytes(data) if err != nil { proxywasm.LogErrorf(\"error decoding plugin configuration: %v\", err) return types.OnPluginStartStatusFailed } headers := v.GetArray(\"headers\") ctx.Headers = make([]header, len(headers)) for i, hdr := range headers { ctx.Headers[i] = header{ Name: string(hdr.GetStringBytes(\"name\")), Value: string(hdr.GetStringBytes(\"value\")), } } return types.OnPluginStartStatusOK } // each HTTP request to a route has its own HTTPContext func (ctx *pluginContext) NewHttpContext(contextID uint32) types.HttpContext { return \u0026httpContext{parent: ctx} } type httpContext struct { types.DefaultHttpContext parent *pluginContext } func (ctx *httpContext) OnHttpResponseHeaders(numHeaders int, endOfStream bool) types.Action { plugin := ctx.parent for _, hdr := range plugin.Headers { proxywasm.ReplaceHttpResponseHeader(hdr.Name, hdr.Value) } return types.ActionContinue } To compile our plugin to a Wasm binary, we can run:\ntinygo build -o custom_response_header.go.wasm -target=wasi ./main.go Configuring APISIX to Run the Plugin To use the Wasm plugin, we first have to update our APISIX configuration file to add this:\nwasm: plugins: - name: custom-response-header priority: 7000 file: /opt/apisix/wasm/custom_response_header.go.wasm Now we can create a route and enable this plugin:\nroutes: - uri: /* upstream: type: roundrobin nodes: \"127.0.0.1:80\": 1 plugins: custom-response-header: conf: |{ \"headers\": [{ \"name\": \"X-Go-Wasm\", \"value\": \"APISIX\" }] } #END Testing the Plugin We can send a request to the created route to test the plugin:\ncurl http://127.0.0.1:9080 -s --head The response header would be as shown below:\n... X-Go-Wasm: APISIX Wasm for the Win? From this article, it seems like using Wasm plugins benefits both users and APISIX maintainers.\nA test using our example custom-response-header function implemented through a Lua plugin, an external Go plugin runner, and a Wasm plugin show how the performance varies:\n Wasm plugins aren't that bad!Running 30s tests with 5 threads and 50 connections using wrk\n  Looking solely at this example, it might be tempting to ask why anyone would want to use plugin runners or write Lua plugins. Well, all the advantages of using Wasm comes with the following caveats:\n Limited plugins: The Wasm implementation of programming languages often lacks complete support. For Go, we were limited to using the TinyGo compiler, similar to other languages. Immature stack: Wasm and its usage outside the browser is still a relatively new concept. The proxy-wasm spec also has its limitations due to its relative novelty. Lack of concurrency: Wasm does not have built-in concurrency support. This could be a deal breaker for typical APISIX uses cases where high performance is critical. Better alternatives: Since APISIX can be extended using Lua plugins or plugin runners, there are always alternatives to using Wasm.  Despite these caveats, the future of Wasm in APISIX and other proxies seems promising. You can choose to hop on the Wasm bandwagon if its benefits tip the scale against these costs. But currently, APISIX plans to continue supporting all three ways of creating custom plugins for the foreseeable future.\n","wordCount":"920","inLanguage":"en","image":"https://navendu.me/images/tiny-apisix-plugin/gopher-banner.jpg","datePublished":"2023-07-07T09:40:14+05:30","dateModified":"2023-10-12T15:48:14+05:30","author":{"@type":"Person","name":"Navendu Pottekkat"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://navendu.me/posts/tiny-apisix-plugin/"},"publisher":{"@type":"Person","name":"Navendu Pottekkat","logo":{"@type":"ImageObject","url":"https://navendu.me/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://navendu.me/ accesskey=h title="Navendu Pottekkat (Alt + H)">Navendu Pottekkat</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://navendu.me/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://navendu.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://navendu.me/dailies/ title="Daily Logs"><span>Daily Logs</span></a></li><li><a href=https://navendu.me/about/ title=About><span>About</span></a></li><li><a href=https://navendu.me/subscribe/ title=Subscribe><span>Subscribe</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://navendu.me/>Home</a>&nbsp;»&nbsp;<a href=https://navendu.me/posts/>Posts</a></div><h1 class=post-title>A "Tiny" APISIX Plugin</h1><div class=post-meta><span title="2023-07-07 09:40:14 +0530 +0530">July 7, 2023</span>&nbsp;·&nbsp;5 min&nbsp;|&nbsp;<a href=https://github.com/pottekkat/personal-website/blob/hugo/content/posts/tiny-apisix-plugin.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://navendu.me/images/tiny-apisix-plugin/gopher-banner.jpg alt="A gopher coming out of its cave."><p>Photo by <a href=https://www.pexels.com/photo/gopher-on-gray-soil-13631585/>Reagan Ross</a></p></figure><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on twitter' href="https://twitter.com/intent/tweet/?text=A%20%22Tiny%22%20APISIX%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f&hashtags=apacheapisix%2capigateway%2cwasm%2ctutorials"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on linkedin' href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f&title=A%20%22Tiny%22%20APISIX%20Plugin&summary=A%20%22Tiny%22%20APISIX%20Plugin&source=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on reddit' href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f&title=A%20%22Tiny%22%20APISIX%20Plugin"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on facebook' href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on whatsapp' href="https://api.whatsapp.com/send?text=A%20%22Tiny%22%20APISIX%20Plugin%20-%20https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on telegram' href="https://telegram.me/share/url?text=A%20%22Tiny%22%20APISIX%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><div class=post-content><p>A key feature of Apache APISIX is its pluggable architecture. In addition to providing <a href="https://apisix.apache.org/plugins/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>80+ Lua plugins</a> out of the box, APISIX also supports external plugins written in other languages through <a href="https://apisix.apache.org/docs/go-plugin-runner/getting-started/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>plugin runners</a> and <a href="https://apisix.apache.org/docs/apisix/wasm/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>WebAssembly (Wasm)</a>.</p><p>In this article, we will write a &ldquo;tiny&rdquo; Go plugin for APISIX, compile it to a Wasm binary, run it in APISIX, and learn how it all works. We will also compare the benefits and costs of using Wasm plugins, external plugins (plugin runners), and native Lua plugins.</p><h2 id=apisix-and-wasm>APISIX and Wasm<a hidden class=anchor aria-hidden=true href=#apisix-and-wasm>#</a></h2><p>APISIX supports Wasm through the <a href="https://github.com/proxy-wasm/spec?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>WebAssembly for Proxies (proxy-wasm) specification</a>. APISIX is a host environment that implements the specification, and developers can use the <a href="https://github.com/proxy-wasm/spec#sdks?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>SDKs</a> available in multiple languages to create plugins.</p><p>Using Wasm plugins in APISIX has multiple advantages:</p><ul><li>Many programming languages compile to Wasm. This allows you to leverage the capabilities of your tech stack in APISIX plugins.</li><li>The plugins run inside APISIX and not on external plugin runners. This means you compromise less on performance while writing external plugins.</li><li>Wasm plugins run inside APISIX but in a separate VM. So even if the plugin crashes, APISIX can continue to run.</li><li><em>APISIX can only maintain its Wasm support without having to maintain plugin runners for multiple languages*.</em></li></ul><p><em>* These advantages come with a set of caveats which we will look at later.</em></p><p>APISIX&rsquo;s plugin architecture below shows native Lua plugins, external plugins through plugin runners, and Wasm plugins:</p><figure class=align-center><a href=/images/tiny-apisix-plugin/plugin-route.png target=_blank><img loading=lazy src=/images/tiny-apisix-plugin/plugin-route.png#center alt="Lua plugins, plugin runners, and Wasm plugins"></a><figcaption>Lua plugins, plugin runners, and Wasm plugins</figcaption></figure><h2 id=a-tiny-go-plugin>A &ldquo;Tiny&rdquo; Go Plugin<a hidden class=anchor aria-hidden=true href=#a-tiny-go-plugin>#</a></h2><p>Let&rsquo;s get coding! To write a Go plugin, we will use the <a href="https://github.com/tetratelabs/proxy-wasm-go-sdk?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>proxy-wasm-go-sdk</a>.</p><p>Reading through the documentation, you will understand why this plugin is called &ldquo;tiny,&rdquo; i.e., the SDK uses the <a href="https://tinygo.org/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>TinyGo</a> compiler instead of the official Go compiler. You can read more about why this is the case on the <a href="https://github.com/tetratelabs/proxy-wasm-go-sdk/blob/main/doc/OVERVIEW.md?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>SDK's overview page</a>, but the TLDR version is that the Go compiler can only produce Wasm binaries that run in the browser.</p><p>For our example, we will create a plugin that adds a response header. The code below is pretty self-explanatory, and you can refer to <a href="https://github.com/apache/apisix/blob/master/t/wasm/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=a-tiny-apisix-plugin" target=_blank>other plugins</a> for more implementation details:</p><div class=highlight title=main.go><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// references:
</span><span style=color:#75715e>// https://github.com/tetratelabs/proxy-wasm-go-sdk/tree/main/examples
</span><span style=color:#75715e>// https://github.com/apache/apisix/blob/master/t/wasm/
</span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm&#34;</span>
	<span style=color:#e6db74>&#34;github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types&#34;</span>

	<span style=color:#e6db74>&#34;github.com/valyala/fastjson&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>proxywasm</span>.<span style=color:#a6e22e>SetVMContext</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>vmContext</span>{})
}

<span style=color:#75715e>// each plugin has its own VMContext.
</span><span style=color:#75715e>// it is responsible for creating multiple PluginContexts for each route.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>vmContext</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>DefaultVMContext</span>
}

<span style=color:#75715e>// each route has its own PluginContext.
</span><span style=color:#75715e>// it corresponds to one instance of the plugin.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>vmContext</span>) <span style=color:#a6e22e>NewPluginContext</span>(<span style=color:#a6e22e>contextID</span> <span style=color:#66d9ef>uint32</span>) <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>PluginContext</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pluginContext</span>{}
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>header</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Name</span>  <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>Value</span> <span style=color:#66d9ef>string</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pluginContext</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>DefaultPluginContext</span>
	<span style=color:#a6e22e>Headers</span> []<span style=color:#a6e22e>header</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pluginContext</span>) <span style=color:#a6e22e>OnPluginStart</span>(<span style=color:#a6e22e>pluginConfigurationSize</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>OnPluginStartStatus</span> {
	<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proxywasm</span>.<span style=color:#a6e22e>GetPluginConfiguration</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>proxywasm</span>.<span style=color:#a6e22e>LogErrorf</span>(<span style=color:#e6db74>&#34;error reading plugin configuration: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>OnPluginStartStatusFailed</span>
	}

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>p</span> <span style=color:#a6e22e>fastjson</span>.<span style=color:#a6e22e>Parser</span>
	<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ParseBytes</span>(<span style=color:#a6e22e>data</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>proxywasm</span>.<span style=color:#a6e22e>LogErrorf</span>(<span style=color:#e6db74>&#34;error decoding plugin configuration: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>OnPluginStartStatusFailed</span>
	}
	<span style=color:#a6e22e>headers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>GetArray</span>(<span style=color:#e6db74>&#34;headers&#34;</span>)
	<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Headers</span> = make([]<span style=color:#a6e22e>header</span>, len(<span style=color:#a6e22e>headers</span>))
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>hdr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>headers</span> {
		<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Headers</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>header</span>{
			<span style=color:#a6e22e>Name</span>:  string(<span style=color:#a6e22e>hdr</span>.<span style=color:#a6e22e>GetStringBytes</span>(<span style=color:#e6db74>&#34;name&#34;</span>)),
			<span style=color:#a6e22e>Value</span>: string(<span style=color:#a6e22e>hdr</span>.<span style=color:#a6e22e>GetStringBytes</span>(<span style=color:#e6db74>&#34;value&#34;</span>)),
		}
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>OnPluginStartStatusOK</span>
}

<span style=color:#75715e>// each HTTP request to a route has its own HTTPContext
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pluginContext</span>) <span style=color:#a6e22e>NewHttpContext</span>(<span style=color:#a6e22e>contextID</span> <span style=color:#66d9ef>uint32</span>) <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>HttpContext</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>httpContext</span>{<span style=color:#a6e22e>parent</span>: <span style=color:#a6e22e>ctx</span>}
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>httpContext</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>DefaultHttpContext</span>
	<span style=color:#a6e22e>parent</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pluginContext</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>httpContext</span>) <span style=color:#a6e22e>OnHttpResponseHeaders</span>(<span style=color:#a6e22e>numHeaders</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>endOfStream</span> <span style=color:#66d9ef>bool</span>) <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>Action</span> {
	<span style=color:#a6e22e>plugin</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>parent</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>hdr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>plugin</span>.<span style=color:#a6e22e>Headers</span> {
		<span style=color:#a6e22e>proxywasm</span>.<span style=color:#a6e22e>ReplaceHttpResponseHeader</span>(<span style=color:#a6e22e>hdr</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>hdr</span>.<span style=color:#a6e22e>Value</span>)
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>ActionContinue</span>
}
</code></pre></div><p>To compile our plugin to a Wasm binary, we can run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>tinygo build -o custom_response_header.go.wasm -target<span style=color:#f92672>=</span>wasi ./main.go
</code></pre></div><h2 id=configuring-apisix-to-run-the-plugin>Configuring APISIX to Run the Plugin<a hidden class=anchor aria-hidden=true href=#configuring-apisix-to-run-the-plugin>#</a></h2><p>To use the Wasm plugin, we first have to update our APISIX configuration file to add this:</p><div class=highlight title=config.yaml><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>wasm</span>:
  <span style=color:#f92672>plugins</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>custom-response-header</span>
      <span style=color:#f92672>priority</span>: <span style=color:#ae81ff>7000</span>
      <span style=color:#f92672>file</span>: <span style=color:#ae81ff>/opt/apisix/wasm/custom_response_header.go.wasm</span>
</code></pre></div><p>Now we can create a route and enable this plugin:</p><div class=highlight title=apisix.yaml><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>routes</span>:
  - <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>/*</span>
    <span style=color:#f92672>upstream</span>:
      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>roundrobin</span>
      <span style=color:#f92672>nodes</span>:
        <span style=color:#f92672>&#34;127.0.0.1:80&#34;: </span><span style=color:#ae81ff>1</span>
    <span style=color:#f92672>plugins</span>:
      <span style=color:#f92672>custom-response-header</span>:
       <span style=color:#f92672>conf</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>        {
</span><span style=color:#e6db74>          &#34;headers&#34;: [{
</span><span style=color:#e6db74>            &#34;name&#34;: &#34;X-Go-Wasm&#34;, &#34;value&#34;: &#34;APISIX&#34;
</span><span style=color:#e6db74>          }]
</span><span style=color:#e6db74>        }</span>        
<span style=color:#75715e>#END</span>
</code></pre></div><h2 id=testing-the-plugin>Testing the Plugin<a hidden class=anchor aria-hidden=true href=#testing-the-plugin>#</a></h2><p>We can send a request to the created route to test the plugin:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl http://127.0.0.1:9080 -s --head
</code></pre></div><p>The response header would be as shown below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>...
X-Go-Wasm: APISIX
</code></pre></div><h2 id=wasm-for-the-win>Wasm for the Win?<a hidden class=anchor aria-hidden=true href=#wasm-for-the-win>#</a></h2><p>From this article, it seems like using Wasm plugins benefits both users and APISIX maintainers.</p><p>A test using our example <code>custom-response-header</code> function implemented through a Lua plugin, an external Go plugin runner, and a Wasm plugin show how the performance varies:</p><figure class=align-center><a href=/images/tiny-apisix-plugin/plugin-performance.png target=_blank><img loading=lazy src=/images/tiny-apisix-plugin/plugin-performance.png#center alt="Wasm plugins aren&amp;rsquo;t that bad!"></a><figcaption>Wasm plugins aren't that bad!<p>Running 30s tests with 5 threads and 50 connections using <a href=https://github.com/wg/wrk>wrk</a></p></figcaption></figure><p>Looking solely at this example, it might be tempting to ask why anyone would want to use plugin runners or write Lua plugins. Well, all the advantages of using Wasm comes with the following caveats:</p><ul><li><strong>Limited plugins</strong>: The Wasm implementation of programming languages often lacks complete support. For Go, we were limited to using the TinyGo compiler, similar to other languages.</li><li><strong>Immature stack</strong>: Wasm and its usage outside the browser is still a relatively new concept. The proxy-wasm spec also has its limitations due to its relative novelty.</li><li><strong>Lack of concurrency</strong>: Wasm does not have built-in concurrency support. This could be a deal breaker for typical APISIX uses cases where high performance is critical.</li><li><strong>Better alternatives</strong>: Since APISIX can be extended using Lua plugins or plugin runners, there are always alternatives to using Wasm.</li></ul><p>Despite these caveats, the future of Wasm in APISIX and other proxies seems promising. You can choose to hop on the Wasm bandwagon if its benefits tip the scale against these costs. But currently, APISIX plans to continue supporting all three ways of creating custom plugins for the foreseeable future.</p><section class=subscribe-content><hr><p>Thank you for reading <i>"A "Tiny" APISIX Plugin."</i></p><p>Subscribe via <a href=/subscribe>email</a> or
<a href=/index.xml target=_blank>RSS feed</a> to be the first to receive
my content.</p><p>If you liked this post, check out my <a href=/categories/featured>featured posts</a> or learn more <a href=/about>about me</a>.</p></section><section class=subscription-form><form action="https://navendu.us5.list-manage.com/subscribe/post-json?u=fb9ffeb3ee6bc8aaf1d5b8a98&id=5ff8367bc1&c=?" method=post autocomplete=off class=subscribe-form><div class=subscribe-input><input type=email name=EMAIL id=email required placeholder="Email Address ↵" title="Email Address"></div><input value=Subscribe type=submit class=subscribe-button title=Subscribe></form><section class=entry-content><div class=subscribe-message>Get a biweekly dose of tech news, curated content, and uninterrupted musings.</div></section></section><script>$(".subscribe-form").submit(function(d){var a,b,c;d.preventDefault(),a=$(this),b=a.attr("action"),c=a.attr("method"),$.ajax({type:c,url:b,data:a.serialize(),dataType:`jsonp`,success:function(b){b.result===`success`?(a.find(".subscribe-button").attr("value","Subscribed!"),$(".subscribe-message").html("Thank you for subscribing! Check your inbox and add me in your contacts to not miss an issue! <a target='_blank' href='https://twitter.com/intent/tweet?url=https%3A%2F%2Fnavendu.me&text=I%20just%20subscribed%20to%20@sudo_navendu%27s%20blog%21%20Check%20it%20out%21&hashtags=OpenSource%2CDevelopers%2CDEVCommunity'>Tweet about it</a>!"),$(".subscribe-form :input").prop("disabled",!0)):(a.find(".subscribe-button").attr("value","Failed to Subscribe! Click again to retry"),$(".subscribe-message").html("There was an error subscribing you to my blog. "+b.msg+"."),a[0].reset()),console.log(b)},error:function(b){console.log("An error occurred."),console.log(b),a[0].reset()}})})</script></div><footer class=post-footer><ul class=post-tags><li><a href=https://navendu.me/tags/apache-apisix/>apache apisix</a></li><li><a href=https://navendu.me/tags/api-gateway/>api gateway</a></li><li><a href=https://navendu.me/tags/wasm/>wasm</a></li><li><a href=https://navendu.me/tags/tutorials/>tutorials</a></li></ul><nav class=paginav><a class=prev href=https://navendu.me/posts/regex-grunt-work/><span class=title>« Prev</span><br><span>Grunt Work with RegEx</span></a>
<a class=next href=https://navendu.me/posts/iot-to-cloud/><span class=title>Next »</span><br><span>Connecting IoT Devices to the Cloud</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on twitter' href="https://twitter.com/intent/tweet/?text=A%20%22Tiny%22%20APISIX%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f&hashtags=apacheapisix%2capigateway%2cwasm%2ctutorials"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on linkedin' href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f&title=A%20%22Tiny%22%20APISIX%20Plugin&summary=A%20%22Tiny%22%20APISIX%20Plugin&source=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on reddit' href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f&title=A%20%22Tiny%22%20APISIX%20Plugin"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on facebook' href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on whatsapp' href="https://api.whatsapp.com/send?text=A%20%22Tiny%22%20APISIX%20Plugin%20-%20https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label='share A "Tiny" APISIX Plugin on telegram' href="https://telegram.me/share/url?text=A%20%22Tiny%22%20APISIX%20Plugin&url=https%3a%2f%2fnavendu.me%2fposts%2ftiny-apisix-plugin%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>This work by <a href=https://navendu.me/about/#about-me>Navendu Pottekkat</a></span>
<span>is licensed under <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script><script>for(var els=document.getElementsByClassName("highlight"),i=0,title,code,newNode;i<els.length;i++)title=els[i].title,code=els[i].firstElementChild.firstElementChild,title.length&&(newNode=document.createElement("div"),newNode.textContent=title,newNode.classList.add("highlight-title"),code.parentNode.insertBefore(newNode,code))</script></body></html>