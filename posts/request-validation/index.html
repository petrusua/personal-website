<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Your API Requests Should Be Validated | Navendu Pottekkat</title><meta name=keywords content="apache apisix,api gateway,tutorials"><meta name=description content="Adding a new layer of validation within your API gateway can be a useful design practice for a myriad of reasons. This article explores how you can configure this in Apache APISIX."><meta name=author content="Navendu Pottekkat"><link rel=canonical href=https://navendu.me/posts/request-validation/><script defer data-domain=navendu.me src=/misc/js/script.js data-api=/misc/api/event></script><script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script><script></script><link crossorigin=anonymous href=/assets/css/stylesheet.66e3e513d75c2ff303648a5691fa6787b3c8f1dc4b3307618713a4dc494f0696.css integrity="sha256-ZuPlE9dcL/MDZIpWkfpnh7PI8dxLMwdhhxOk3ElPBpY=" rel="preload stylesheet" as=style><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://navendu.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://navendu.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://navendu.me/favicon-32x32.png><link rel=apple-touch-icon href=https://navendu.me/apple-touch-icon.png><link rel=mask-icon href=https://navendu.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Your API Requests Should Be Validated"><meta property="og:description" content="Adding a new layer of validation within your API gateway can be a useful design practice for a myriad of reasons. This article explores how you can configure this in Apache APISIX."><meta property="og:type" content="article"><meta property="og:url" content="https://navendu.me/posts/request-validation/"><meta property="og:image" content="https://navendu.me/images/request-validation/stamp-banner.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-05T15:35:09+05:30"><meta property="article:modified_time" content="2023-08-28T09:36:08+05:30"><meta property="og:site_name" content="Navendu Pottekkat"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://navendu.me/images/request-validation/stamp-banner.jpg"><meta name=twitter:title content="Your API Requests Should Be Validated"><meta name=twitter:description content="Adding a new layer of validation within your API gateway can be a useful design practice for a myriad of reasons. This article explores how you can configure this in Apache APISIX."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://navendu.me/posts/"},{"@type":"ListItem","position":2,"name":"Your API Requests Should Be Validated","item":"https://navendu.me/posts/request-validation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Your API Requests Should Be Validated","name":"Your API Requests Should Be Validated","description":"Adding a new layer of validation within your API gateway can be a useful design practice for a myriad of reasons. This article explores how you can configure this in Apache APISIX.","keywords":["apache apisix","api gateway","tutorials"],"articleBody":"One of the most overlooked aspects while designing APIs is request validation.\nAn API gateway like Apache APISIX, predominantly used for fine-grained traffic control, can also validate your API requests. This new layer of validation within the API gateway, along with client-side and application-side validations, can be a useful design practice for many reasons, like:\n Preventing invalid requests from being sent to backend services, reducing unnecessary load and thereby optimizing performance and reducing cost. Allowing application developers to focus solely on application/business-specific validations in their services. Adding another layer of security in front of your backend services, fending off malicious requests from ever reaching your services.  In this article, you will learn how you can configure APISIX to validate requests with JSON schemas before forwarding them to your upstream services.\nCreating the Schema For this example, our request will contain a purchase request sent from a client application to the payment service through the APISIX API gateway. A valid request body will look like this:\n{ \"uid\": 2374, \"item\": \"pin\", \"quantity\": 5, \"price\": 5.0 } Each key in this request represents the following:\n uid: Unique ID of the user. It will be empty for a guest user. item: Item being purchased. It can be one of “sticker,” “t-shirt,” or “pin.” quantity: Quantity of the item being purchased. price: Price of the item being purchased.  There are a lot of tools available, like the one from JSON formatter that converts JSON to JSON schema. But we will write our own schema to be more accurate:\n{ \"type\": \"object\", \"required\": [\"quantity\", \"price\", \"item\"], \"properties\": { \"uid\": { \"type\": \"integer\" }, \"item\": { \"type\": \"string\", \"enum\": [\"sticker\", \"t-shirt\", \"pin\"] }, \"quantity\": { \"type\": \"integer\", \"minimum\": 1, \"maximum\": 50 }, \"price\": { \"type\": \"number\", \"minimum\": 1.0, \"maximum\": 50.0 } } } You can learn more about writing JSON schemas from the official website.\nSetting Up APISIX Since this article focuses on request validation at the API gateway level, we will deploy a simple setup consisting of Apache APISIX and the sample HTTPBin service:\n Simple deploymentThe Docker Compose file below deploys everything\n  APISIX will forward the request to HTTPBin only if the request is validated. HTTPBin then sends a response containing all the data from the request, which we can validate.\nThe Docker Compose file below sets everything up as described above:\nversion: \"3\" services: apisix: image: apache/apisix:3.4.1-debian volumes: - ./apisix/config.yml:/usr/local/apisix/conf/config.yaml:ro - ./apisix/apisix.yml:/usr/local/apisix/conf/apisix.yaml:ro ports: - \"9080:9080\" - \"9180:9180\" httpbin: image: kennethreitz/httpbin ports: - \"80:80\" APISIX performs request validation through, you guessed it, the request-validation plugin. To use the plugin, you have to enable it in your config.yaml file. For this example, I have deployed APISIX in standalone mode. So my entire config.yaml file looks like this:\ndeployment: role: data_plane role_data_plane: config_provider: yaml plugins: - request-validation #END Configuring Request Validation We can now create a route in APISIX with the request-validation plugin. We will configure the plugin using the schema we created before. Since I’m configuring APISIX through a static configuration file in standalone mode, my configuration will look like this:\nroutes: - uri: /anything/* upstream: type: roundrobin nodes: \"httpbin:80\": 1 plugins: request-validation: body_schema: type: object required: - quantity - price - item properties: uid: type: integer item: type: string enum: - sticker - t-shirt - pin quantity: type: integer price: type: number #END If you are not using APISIX in standalone mode, you can use the Admin API for this exact configuration:\ncurl \"http://127.0.0.1:9180/apisix/admin/routes\" -X PUT -d ' { \"id\": \"valid-route\", \"uri\": \"/anything/*\", \"plugins\": { \"request-validation\": { \"body_schema\": { \"type\": \"object\", \"required\": [\"quantity\", \"price\", \"item\"], \"properties\": { \"uid\": { \"type\": \"integer\" }, \"item\": { \"type\": \"string\", \"enum\": [\"sticker\", \"t-shirt\", \"pin\"] }, \"quantity\": { \"type\": \"integer\", }, \"price\": { \"type\": \"number\", } } } } }, \"upstream\": { \"type\": \"roundrobin\", \"nodes\": { \"httpbin:80\": 1 } } }' Testing the Configuration Now we can send a request to the created route. We can first try a request with an invalid body:\ncurl localhost:9080/anything/anything -H \"Content-Type: application/json\" -d ' { \"uid\": 2374, \"item\": \"hoodie\", \"quantity\": 5, \"price\": 10.99 }' You should get back a 400 response as expected:\nproperty \"item\" validation failed: matches none of the enum values Now if you send a valid request, you will get back the response from HTTPBin:\ncurl localhost:9080/anything/anything -H \"Content-Type: application/json\" -d ' { \"uid\": 4639, \"item\": \"sticker\", \"quantity\": 20, \"price\": 20.0 }' { \"args\": {}, \"data\": \"{\\\"price\\\":20,\\\"quantity\\\":20,\\\"uid\\\":4639,\\\"item\\\":\\\"sticker\\\"}\", \"files\": {}, \"form\": {}, \"headers\": { \"Accept\": \"*/*\", \"Content-Length\": \"54\", \"Content-Type\": \"application/json\", \"Host\": \"localhost:9080\", \"User-Agent\": \"curl/7.88.1\", \"X-Forwarded-Host\": \"localhost\" }, \"json\": { \"item\": \"sticker\", \"price\": 20, \"quantity\": 20, \"uid\": 4639 }, \"method\": \"POST\", \"origin\": \"172.22.0.1, 223.239.0.41\", \"url\": \"http://localhost/anything/anything\" } Non-trivial Vulnerabilities Different services might use different JSON parsing implementations. Sometimes, this could lead to different parsed JSON in different services. This can open up a lot of non-trivial interoperability vulnerabilities.\nFor example, a client can send a malicious request with duplicate keys, and two different services might end up using two different keys:\n{ \"uid\": 8495, \"item\": \"sticker\", \"quantity\": 20, \"price\": 20.0, \"price\": 0.0 } Now if this happens in a shopping cart and a payment service, i.e., the shopping cart has the price of 20.0, and the payments service has the price of 0.0, a malicious user could effectively make purchases for free!\nAn obvious solution here would be to configure better validation. For example, you can update the configuration to check for minimum and maximum values to ensure such malicious requests are rejected:\nroutes: - uri: /anything/* upstream: type: roundrobin nodes: \"httpbin:80\": 1 plugins: request-validation: body_schema: type: object required: - quantity - price - item properties: uid: type: integer item: type: string enum: - sticker - t-shirt - pin quantity: type: integer minimum: 1 maximum: 50  price: type: number minimum: 1.0 maximum: 50.0 #END But APISIX handles this vulnerability in a more robust way by only forwarding the validated request body. This means that APISIX parses the request body, validates it, encodes the validated body, and forwards it to the upstream. Now every service after APISIX uses the same validated request body from APISIX:\ncurl localhost:9080/anything/anything -H \"Content-Type: application/json\" -d ' { \"uid\": 8495, \"item\": \"sticker\", \"quantity\": 20, \"price\": 20.0, \"price\": 1.0 }' { \"args\": {}, \"data\": \"{\\\"quantity\\\":20,\\\"uid\\\":4639,\\\"price\\\":1,\\\"item\\\":\\\"sticker\\\"}\", \"files\": {}, \"form\": {}, \"headers\": { \"Accept\": \"*/*\", \"Content-Length\": \"53\", \"Content-Type\": \"application/json\", \"Host\": \"localhost:9080\", \"User-Agent\": \"curl/7.88.1\", \"X-Forwarded-Host\": \"localhost\" }, \"json\": { \"item\": \"sticker\", \"price\": 1,  \"quantity\": 20, \"uid\": 4639 }, \"method\": \"POST\", \"origin\": \"172.22.0.1, 223.239.0.41\", \"url\": \"http://localhost/anything/anything\" } This excellent blog post sums up some more JSON interoperability vulnerabilities.\nComplex Validation What we discussed so far only included some basic validation. But APISIX has much more capabilities.\nYou can also configure a schema for validating headers, set a custom response code/message, and validate strings using regular expressions:\nroutes: - uri: /anything/* upstream: type: roundrobin nodes: \"httpbin:80\": 1 plugins: request-validation: rejected_code: 418 rejected_message: \"I'm an intelligent Teapot!\" header_schema:  type: object required: - Content-Type properties: Content-Type: type: string pattern: \"^application\\/json$\"  body_schema: type: object required: - quantity - price - item properties: uid: type: integer item: type: string enum: - sticker - t-shirt - pin quantity: type: integer minimum: 1 maximum: 50 price: type: number minimum: 1.0 maximum: 50.0 #END You can also set the specific version of the JSON schema used from draft 4, draft 6, and draft 7 to ensure accurate parsing by adding this key:\n\"$schema\": \"http://json-schema.org/draft-04/schema#\" Why Where to Validate? It is fair to assume that you now understand why request validation might be necessary. However, you could still argue that validation can be done on the client side or within your backend services.\nA key point is that you might not always own your clients, or modifying client requests might be not relatively easy. Adding validation in a layer you have absolute control of is the better alternative.\nSo why can’t you validate requests in your services directly? Well, after a point, it becomes too complex for the application developer to configure both request validation (header/body validation) and application/business-specific validation. Without an API gateway layer, invalid requests still end up adding load to your backend services.\nIdeally, you should validate requests in all three layers with only business-specific validation in your services. The APISIX Dashboard can export the configured routes to OpenAPI format, which can be used for client-side validation.\nTo learn more about APISIX’s other capabilities as an API gateway, see apisix.apache.org.\n","wordCount":"1381","inLanguage":"en","image":"https://navendu.me/images/request-validation/stamp-banner.jpg","datePublished":"2023-08-05T15:35:09+05:30","dateModified":"2023-08-28T09:36:08+05:30","author":{"@type":"Person","name":"Navendu Pottekkat"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://navendu.me/posts/request-validation/"},"publisher":{"@type":"Person","name":"Navendu Pottekkat","logo":{"@type":"ImageObject","url":"https://navendu.me/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://navendu.me/ accesskey=h title="Navendu Pottekkat (Alt + H)">Navendu Pottekkat</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://navendu.me/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://navendu.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://navendu.me/dailies/ title="Daily Logs"><span>Daily Logs</span></a></li><li><a href=https://navendu.me/about/ title=About><span>About</span></a></li><li><a href=https://navendu.me/subscribe/ title=Subscribe><span>Subscribe</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://navendu.me/>Home</a>&nbsp;»&nbsp;<a href=https://navendu.me/posts/>Posts</a></div><h1 class=post-title>Your API Requests Should Be Validated</h1><div class=post-meta><span title="2023-08-05 15:35:09 +0530 +0530">August 5, 2023</span>&nbsp;·&nbsp;7 min&nbsp;|&nbsp;<a href=https://github.com/pottekkat/personal-website/blob/hugo/content/posts/request-validation.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://navendu.me/images/request-validation/stamp-banner.jpg alt="A person stamping a request."></figure><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on twitter" href="https://twitter.com/intent/tweet/?text=Your%20API%20Requests%20Should%20Be%20Validated&url=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f&hashtags=apacheapisix%2capigateway%2ctutorials"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f&title=Your%20API%20Requests%20Should%20Be%20Validated&summary=Your%20API%20Requests%20Should%20Be%20Validated&source=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f&title=Your%20API%20Requests%20Should%20Be%20Validated"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on whatsapp" href="https://api.whatsapp.com/send?text=Your%20API%20Requests%20Should%20Be%20Validated%20-%20https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on telegram" href="https://telegram.me/share/url?text=Your%20API%20Requests%20Should%20Be%20Validated&url=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#creating-the-schema aria-label="Creating the Schema">Creating the Schema</a></li><li><a href=#setting-up-apisix aria-label="Setting Up APISIX">Setting Up APISIX</a></li><li><a href=#configuring-request-validation aria-label="Configuring Request Validation">Configuring Request Validation</a></li><li><a href=#testing-the-configuration aria-label="Testing the Configuration">Testing the Configuration</a></li><li><a href=#non-trivial-vulnerabilities aria-label="Non-trivial Vulnerabilities">Non-trivial Vulnerabilities</a></li><li><a href=#complex-validation aria-label="Complex Validation">Complex Validation</a></li><li><a href=#why-where-to-validate aria-label="Why Where to Validate?"><del>Why</del> Where to Validate?</a></li></ul></div></details></div><div class=post-content><p>One of the most overlooked aspects while designing APIs is request validation.</p><p>An API gateway like <a href="https://apisix.apache.org/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>Apache APISIX</a>, predominantly used for fine-grained traffic control, can also validate your API requests. This new layer of validation within the API gateway, along with client-side and application-side validations, can be a useful design practice for many reasons, like:</p><ol><li>Preventing invalid requests from being sent to backend services, reducing unnecessary load and thereby optimizing performance and reducing cost.</li><li>Allowing application developers to focus solely on application/business-specific validations in their services.</li><li>Adding another layer of security in front of your backend services, fending off malicious requests from ever reaching your services.</li></ol><p>In this article, you will learn how you can configure APISIX to validate requests with JSON schemas before forwarding them to your upstream services.</p><h2 id=creating-the-schema>Creating the Schema<a hidden class=anchor aria-hidden=true href=#creating-the-schema>#</a></h2><p>For this example, our request will contain a purchase request sent from a client application to the payment service through the APISIX API gateway. A valid request body will look like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;uid&#34;</span>: <span style=color:#ae81ff>2374</span>,
  <span style=color:#f92672>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;pin&#34;</span>,
  <span style=color:#f92672>&#34;quantity&#34;</span>: <span style=color:#ae81ff>5</span>,
  <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>5.0</span>
}
</code></pre></div><p>Each key in this request represents the following:</p><ul><li><code>uid</code>: Unique ID of the user. It will be empty for a guest user.</li><li><code>item</code>: Item being purchased. It can be one of &ldquo;sticker,&rdquo; &ldquo;t-shirt,&rdquo; or &ldquo;pin.&rdquo;</li><li><code>quantity</code>: Quantity of the item being purchased.</li><li><code>price</code>: Price of the item being purchased.</li></ul><p>There are a lot of tools available, like the one from <a href="https://jsonformatter.org/json-to-jsonschema?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>JSON formatter</a> that converts JSON to JSON schema. But we will write our own schema to be more accurate:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
  <span style=color:#f92672>&#34;required&#34;</span>: [<span style=color:#e6db74>&#34;quantity&#34;</span>, <span style=color:#e6db74>&#34;price&#34;</span>, <span style=color:#e6db74>&#34;item&#34;</span>],
  <span style=color:#f92672>&#34;properties&#34;</span>: {
    <span style=color:#f92672>&#34;uid&#34;</span>: {
      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;integer&#34;</span>
    },
    <span style=color:#f92672>&#34;item&#34;</span>: {
      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;string&#34;</span>,
      <span style=color:#f92672>&#34;enum&#34;</span>: [<span style=color:#e6db74>&#34;sticker&#34;</span>, <span style=color:#e6db74>&#34;t-shirt&#34;</span>, <span style=color:#e6db74>&#34;pin&#34;</span>]
    },
    <span style=color:#f92672>&#34;quantity&#34;</span>: {
      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;integer&#34;</span>,
      <span style=color:#f92672>&#34;minimum&#34;</span>: <span style=color:#ae81ff>1</span>,
      <span style=color:#f92672>&#34;maximum&#34;</span>: <span style=color:#ae81ff>50</span>
    },
    <span style=color:#f92672>&#34;price&#34;</span>: {
      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;number&#34;</span>,
      <span style=color:#f92672>&#34;minimum&#34;</span>: <span style=color:#ae81ff>1.0</span>,
      <span style=color:#f92672>&#34;maximum&#34;</span>: <span style=color:#ae81ff>50.0</span>
    }
  }
}
</code></pre></div><p>You can learn more about writing JSON schemas from the <a href="https://json-schema.org/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>official website</a>.</p><h2 id=setting-up-apisix>Setting Up APISIX<a hidden class=anchor aria-hidden=true href=#setting-up-apisix>#</a></h2><p>Since this article focuses on request validation at the API gateway level, we will deploy a simple setup consisting of Apache APISIX and the sample <a href="https://httpbin.org/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>HTTPBin</a> service:</p><figure class=align-center><a href=/images/request-validation/deployment.png target=_blank><img loading=lazy src=/images/request-validation/deployment.png#center alt="Simple deployment"></a><figcaption>Simple deployment<p>The Docker Compose file below deploys everything</p></figcaption></figure><p>APISIX will forward the request to HTTPBin only if the request is validated. HTTPBin then <a href="https://httpbin.org/#/Anything/post_anything?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>sends a response</a> containing all the data from the request, which we can validate.</p><p>The Docker Compose file below sets everything up as described above:</p><div class=highlight title=docker-compose.yaml><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>

<span style=color:#f92672>services</span>:
  <span style=color:#f92672>apisix</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>apache/apisix:3.4.1-debian</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./apisix/config.yml:/usr/local/apisix/conf/config.yaml:ro</span>
      - <span style=color:#ae81ff>./apisix/apisix.yml:/usr/local/apisix/conf/apisix.yaml:ro</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#e6db74>&#34;9080:9080&#34;</span>
      - <span style=color:#e6db74>&#34;9180:9180&#34;</span>
  <span style=color:#f92672>httpbin</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>kennethreitz/httpbin</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#e6db74>&#34;80:80&#34;</span>
</code></pre></div><p>APISIX performs request validation through, you guessed it, the <a href="https://apisix.apache.org/docs/apisix/plugins/request-validation/#enum-validation?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>request-validation</a> plugin. To use the plugin, you have to enable it in your <code>config.yaml</code> file. For this example, I have deployed APISIX in <a href="https://apisix.apache.org/docs/apisix/deployment-modes/#standalone?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>standalone mode</a>. So my entire <code>config.yaml</code> file looks like this:</p><div class=highlight title=config.yaml><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>deployment</span>:
  <span style=color:#f92672>role</span>: <span style=color:#ae81ff>data_plane</span>
  <span style=color:#f92672>role_data_plane</span>:
    <span style=color:#f92672>config_provider</span>: <span style=color:#ae81ff>yaml</span>
<span style=color:#f92672>plugins</span>:
  - <span style=color:#ae81ff>request-validation</span>
<span style=color:#75715e>#END</span>
</code></pre></div><h2 id=configuring-request-validation>Configuring Request Validation<a hidden class=anchor aria-hidden=true href=#configuring-request-validation>#</a></h2><p>We can now create a route in APISIX with the <code>request-validation</code> plugin. We will configure the plugin using the schema we created before. Since I&rsquo;m configuring APISIX through a static configuration file in standalone mode, my configuration will look like this:</p><div class=highlight title=apisix.yaml><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>routes</span>:
  - <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>/anything/*</span>
    <span style=color:#f92672>upstream</span>:
      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>roundrobin</span>
      <span style=color:#f92672>nodes</span>:
        <span style=color:#f92672>&#34;httpbin:80&#34;: </span><span style=color:#ae81ff>1</span>
    <span style=color:#f92672>plugins</span>:
      <span style=color:#f92672>request-validation</span>:
        <span style=color:#f92672>body_schema</span>:
          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
          <span style=color:#f92672>required</span>:
            - <span style=color:#ae81ff>quantity</span>
            - <span style=color:#ae81ff>price</span>
            - <span style=color:#ae81ff>item</span>
          <span style=color:#f92672>properties</span>:
            <span style=color:#f92672>uid</span>:
              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
            <span style=color:#f92672>item</span>:
              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
              <span style=color:#f92672>enum</span>:
                - <span style=color:#ae81ff>sticker</span>
                - <span style=color:#ae81ff>t-shirt</span>
                - <span style=color:#ae81ff>pin</span>
            <span style=color:#f92672>quantity</span>:
              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
            <span style=color:#f92672>price</span>:
              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>number</span>
<span style=color:#75715e>#END</span>
</code></pre></div><p>If you are not using APISIX in standalone mode, you can use the Admin API for this exact configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl <span style=color:#e6db74>&#34;http://127.0.0.1:9180/apisix/admin/routes&#34;</span> -X PUT -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;id&#34;: &#34;valid-route&#34;,
</span><span style=color:#e6db74>  &#34;uri&#34;: &#34;/anything/*&#34;,
</span><span style=color:#e6db74>  &#34;plugins&#34;: {
</span><span style=color:#e6db74>    &#34;request-validation&#34;: {
</span><span style=color:#e6db74>      &#34;body_schema&#34;: {
</span><span style=color:#e6db74>        &#34;type&#34;: &#34;object&#34;,
</span><span style=color:#e6db74>        &#34;required&#34;: [&#34;quantity&#34;, &#34;price&#34;, &#34;item&#34;],
</span><span style=color:#e6db74>        &#34;properties&#34;: {
</span><span style=color:#e6db74>          &#34;uid&#34;: {
</span><span style=color:#e6db74>            &#34;type&#34;: &#34;integer&#34;
</span><span style=color:#e6db74>          },
</span><span style=color:#e6db74>          &#34;item&#34;: {
</span><span style=color:#e6db74>            &#34;type&#34;: &#34;string&#34;,
</span><span style=color:#e6db74>            &#34;enum&#34;: [&#34;sticker&#34;, &#34;t-shirt&#34;, &#34;pin&#34;]
</span><span style=color:#e6db74>          },
</span><span style=color:#e6db74>          &#34;quantity&#34;: {
</span><span style=color:#e6db74>            &#34;type&#34;: &#34;integer&#34;,
</span><span style=color:#e6db74>          },
</span><span style=color:#e6db74>          &#34;price&#34;: {
</span><span style=color:#e6db74>            &#34;type&#34;: &#34;number&#34;,
</span><span style=color:#e6db74>          }
</span><span style=color:#e6db74>        }
</span><span style=color:#e6db74>      }
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  },
</span><span style=color:#e6db74>  &#34;upstream&#34;: {
</span><span style=color:#e6db74>    &#34;type&#34;: &#34;roundrobin&#34;,
</span><span style=color:#e6db74>    &#34;nodes&#34;: {
</span><span style=color:#e6db74>      &#34;httpbin:80&#34;: 1
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><h2 id=testing-the-configuration>Testing the Configuration<a hidden class=anchor aria-hidden=true href=#testing-the-configuration>#</a></h2><p>Now we can send a request to the created route. We can first try a request with an invalid body:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl localhost:9080/anything/anything -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{ &#34;uid&#34;: 2374, &#34;item&#34;: &#34;hoodie&#34;, &#34;quantity&#34;: 5, &#34;price&#34;: 10.99 }&#39;</span>
</code></pre></div><p>You should get back a 400 response as expected:</p><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>property &#34;item&#34; validation failed: matches none of the enum values
</code></pre></div><p>Now if you send a valid request, you will get back the response from HTTPBin:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl localhost:9080/anything/anything -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{ &#34;uid&#34;: 4639, &#34;item&#34;: &#34;sticker&#34;, &#34;quantity&#34;: 20, &#34;price&#34;: 20.0 }&#39;</span>
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;args&#34;</span>: {},
  <span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;{\&#34;price\&#34;:20,\&#34;quantity\&#34;:20,\&#34;uid\&#34;:4639,\&#34;item\&#34;:\&#34;sticker\&#34;}&#34;</span>,
  <span style=color:#f92672>&#34;files&#34;</span>: {},
  <span style=color:#f92672>&#34;form&#34;</span>: {},
  <span style=color:#f92672>&#34;headers&#34;</span>: {
    <span style=color:#f92672>&#34;Accept&#34;</span>: <span style=color:#e6db74>&#34;*/*&#34;</span>,
    <span style=color:#f92672>&#34;Content-Length&#34;</span>: <span style=color:#e6db74>&#34;54&#34;</span>,
    <span style=color:#f92672>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>,
    <span style=color:#f92672>&#34;Host&#34;</span>: <span style=color:#e6db74>&#34;localhost:9080&#34;</span>,
    <span style=color:#f92672>&#34;User-Agent&#34;</span>: <span style=color:#e6db74>&#34;curl/7.88.1&#34;</span>,
    <span style=color:#f92672>&#34;X-Forwarded-Host&#34;</span>: <span style=color:#e6db74>&#34;localhost&#34;</span>
  },
  <span style=color:#f92672>&#34;json&#34;</span>: {
    <span style=color:#f92672>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;sticker&#34;</span>,
    <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>20</span>,
    <span style=color:#f92672>&#34;quantity&#34;</span>: <span style=color:#ae81ff>20</span>,
    <span style=color:#f92672>&#34;uid&#34;</span>: <span style=color:#ae81ff>4639</span>
  },
  <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;POST&#34;</span>,
  <span style=color:#f92672>&#34;origin&#34;</span>: <span style=color:#e6db74>&#34;172.22.0.1, 223.239.0.41&#34;</span>,
  <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;http://localhost/anything/anything&#34;</span>
}
</code></pre></div><h2 id=non-trivial-vulnerabilities>Non-trivial Vulnerabilities<a hidden class=anchor aria-hidden=true href=#non-trivial-vulnerabilities>#</a></h2><p>Different services might use different JSON parsing implementations. Sometimes, this could lead to different parsed JSON in different services. This can open up a lot of non-trivial interoperability vulnerabilities.</p><p>For example, a client can send a malicious request with duplicate keys, and two different services might end up using two different keys:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;uid&#34;</span>: <span style=color:#ae81ff>8495</span>,
  <span style=color:#f92672>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;sticker&#34;</span>,
  <span style=color:#f92672>&#34;quantity&#34;</span>: <span style=color:#ae81ff>20</span>,
  <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>20.0</span>,
<span style=display:block;width:100%;background-color:#3c3d38>  <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>0.0</span>
</span>}
</code></pre></div><p>Now if this happens in a shopping cart and a payment service, i.e., the shopping cart has the price of <code>20.0</code>, and the payments service has the price of <code>0.0</code>, a malicious user could effectively make purchases for free!</p><p>An obvious solution here would be to configure better validation. For example, you can update the configuration to check for minimum and maximum values to ensure such malicious requests are rejected:</p><div class=highlight title=apisix.yaml><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>routes</span>:
  - <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>/anything/*</span>
    <span style=color:#f92672>upstream</span>:
      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>roundrobin</span>
      <span style=color:#f92672>nodes</span>:
        <span style=color:#f92672>&#34;httpbin:80&#34;: </span><span style=color:#ae81ff>1</span>
    <span style=color:#f92672>plugins</span>:
      <span style=color:#f92672>request-validation</span>:
        <span style=color:#f92672>body_schema</span>:
          <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
          <span style=color:#f92672>required</span>:
            - <span style=color:#ae81ff>quantity</span>
            - <span style=color:#ae81ff>price</span>
            - <span style=color:#ae81ff>item</span>
          <span style=color:#f92672>properties</span>:
            <span style=color:#f92672>uid</span>:
              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
            <span style=color:#f92672>item</span>:
              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
              <span style=color:#f92672>enum</span>:
                - <span style=color:#ae81ff>sticker</span>
                - <span style=color:#ae81ff>t-shirt</span>
                - <span style=color:#ae81ff>pin</span>
            <span style=color:#f92672>quantity</span>:
              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
<span style=display:block;width:100%;background-color:#3c3d38>              <span style=color:#f92672>minimum</span>: <span style=color:#ae81ff>1</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>              <span style=color:#f92672>maximum</span>: <span style=color:#ae81ff>50</span>
</span>            <span style=color:#f92672>price</span>:
              <span style=color:#f92672>type</span>: <span style=color:#ae81ff>number</span>
<span style=display:block;width:100%;background-color:#3c3d38>              <span style=color:#f92672>minimum</span>: <span style=color:#ae81ff>1.0</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>              <span style=color:#f92672>maximum</span>: <span style=color:#ae81ff>50.0</span>
</span><span style=color:#75715e>#END</span>
</code></pre></div><p>But APISIX handles this vulnerability in a more robust way by only forwarding the validated request body. This means that APISIX parses the request body, validates it, encodes the validated body, and forwards it to the upstream. Now every service after APISIX uses the same validated request body from APISIX:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl localhost:9080/anything/anything -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -d <span style=color:#e6db74>&#39;
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;uid&#34;: 8495,
</span><span style=color:#e6db74>  &#34;item&#34;: &#34;sticker&#34;,
</span><span style=color:#e6db74>  &#34;quantity&#34;: 20,
</span><span style=color:#e6db74>  &#34;price&#34;: 20.0,
</span><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#e6db74>  &#34;price&#34;: 1.0
</span></span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><div class=highlight title=output><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;args&#34;</span>: {},
  <span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;{\&#34;quantity\&#34;:20,\&#34;uid\&#34;:4639,\&#34;price\&#34;:1,\&#34;item\&#34;:\&#34;sticker\&#34;}&#34;</span>,
  <span style=color:#f92672>&#34;files&#34;</span>: {},
  <span style=color:#f92672>&#34;form&#34;</span>: {},
  <span style=color:#f92672>&#34;headers&#34;</span>: {
    <span style=color:#f92672>&#34;Accept&#34;</span>: <span style=color:#e6db74>&#34;*/*&#34;</span>,
    <span style=color:#f92672>&#34;Content-Length&#34;</span>: <span style=color:#e6db74>&#34;53&#34;</span>,
    <span style=color:#f92672>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>,
    <span style=color:#f92672>&#34;Host&#34;</span>: <span style=color:#e6db74>&#34;localhost:9080&#34;</span>,
    <span style=color:#f92672>&#34;User-Agent&#34;</span>: <span style=color:#e6db74>&#34;curl/7.88.1&#34;</span>,
    <span style=color:#f92672>&#34;X-Forwarded-Host&#34;</span>: <span style=color:#e6db74>&#34;localhost&#34;</span>
  },
  <span style=color:#f92672>&#34;json&#34;</span>: {
    <span style=color:#f92672>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;sticker&#34;</span>,
<span style=display:block;width:100%;background-color:#3c3d38>    <span style=color:#f92672>&#34;price&#34;</span>: <span style=color:#ae81ff>1</span>,
</span>    <span style=color:#f92672>&#34;quantity&#34;</span>: <span style=color:#ae81ff>20</span>,
    <span style=color:#f92672>&#34;uid&#34;</span>: <span style=color:#ae81ff>4639</span>
  },
  <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;POST&#34;</span>,
  <span style=color:#f92672>&#34;origin&#34;</span>: <span style=color:#e6db74>&#34;172.22.0.1, 223.239.0.41&#34;</span>,
  <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;http://localhost/anything/anything&#34;</span>
}
</code></pre></div><p>This <a href="https://bishopfox.com/blog/json-interoperability-vulnerabilities?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>excellent blog post</a> sums up some more JSON interoperability vulnerabilities.</p><h2 id=complex-validation>Complex Validation<a hidden class=anchor aria-hidden=true href=#complex-validation>#</a></h2><p>What we discussed so far only included some basic validation. But APISIX has much more capabilities.</p><p>You can also configure a schema for validating headers, set a custom response code/message, and validate strings using regular expressions:</p><div class=highlight title=apisix.yaml><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>routes</span>:
  - <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>/anything/*</span>
    <span style=color:#f92672>upstream</span>:
      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>roundrobin</span>
      <span style=color:#f92672>nodes</span>:
        <span style=color:#f92672>&#34;httpbin:80&#34;: </span><span style=color:#ae81ff>1</span>
    <span style=color:#f92672>plugins</span>:
      <span style=color:#f92672>request-validation</span>:
<span style=display:block;width:100%;background-color:#3c3d38>        <span style=color:#f92672>rejected_code</span>: <span style=color:#ae81ff>418</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>        <span style=color:#f92672>rejected_message</span>: <span style=color:#e6db74>&#34;I&#39;m an intelligent Teapot!&#34;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>        <span style=color:#f92672>header_schema</span>:
</span>            <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
            <span style=color:#f92672>required</span>:
              - <span style=color:#ae81ff>Content-Type</span>
            <span style=color:#f92672>properties</span>:
              <span style=color:#f92672>Content-Type</span>:
                <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
<span style=display:block;width:100%;background-color:#3c3d38>                <span style=color:#f92672>pattern</span>: <span style=color:#e6db74>&#34;^application\/json$&#34;</span>
</span>        <span style=color:#f92672>body_schema</span>:
            <span style=color:#f92672>type</span>: <span style=color:#ae81ff>object</span>
            <span style=color:#f92672>required</span>:
              - <span style=color:#ae81ff>quantity</span>
              - <span style=color:#ae81ff>price</span>
              - <span style=color:#ae81ff>item</span>
            <span style=color:#f92672>properties</span>:
              <span style=color:#f92672>uid</span>:
                <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
              <span style=color:#f92672>item</span>:
                <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
                <span style=color:#f92672>enum</span>:
                  - <span style=color:#ae81ff>sticker</span>
                  - <span style=color:#ae81ff>t-shirt</span>
                  - <span style=color:#ae81ff>pin</span>
              <span style=color:#f92672>quantity</span>:
                <span style=color:#f92672>type</span>: <span style=color:#ae81ff>integer</span>
                <span style=color:#f92672>minimum</span>: <span style=color:#ae81ff>1</span>
                <span style=color:#f92672>maximum</span>: <span style=color:#ae81ff>50</span>
              <span style=color:#f92672>price</span>:
                <span style=color:#f92672>type</span>: <span style=color:#ae81ff>number</span>
                <span style=color:#f92672>minimum</span>: <span style=color:#ae81ff>1.0</span>
                <span style=color:#f92672>maximum</span>: <span style=color:#ae81ff>50.0</span>
<span style=color:#75715e>#END</span>
</code></pre></div><p>You can also set the specific version of the JSON schema used from draft 4, draft 6, and draft 7 to ensure accurate parsing by adding this key:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>&#34;$schema&#34;: &#34;http://json-schema.org/draft-04/schema#&#34;
</code></pre></div><h2 id=why-where-to-validate><del>Why</del> Where to Validate?<a hidden class=anchor aria-hidden=true href=#why-where-to-validate>#</a></h2><p>It is fair to assume that you now understand why request validation might be necessary. However, you could still argue that validation can be done on the client side or within your backend services.</p><p>A key point is that you might not always own your clients, or modifying client requests might be not relatively easy. Adding validation in a layer you have absolute control of is the better alternative.</p><p>So why can&rsquo;t you validate requests in your services directly? Well, after a point, it becomes too complex for the application developer to configure both request validation (header/body validation) and application/business-specific validation. Without an API gateway layer, invalid requests still end up adding load to your backend services.</p><p>Ideally, you should validate requests in all three layers with only business-specific validation in your services. The <a href="https://apisix.apache.org/docs/dashboard/USER_GUIDE/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>APISIX Dashboard</a> can export the configured routes to <a href="https://spec.openapis.org/oas/latest.html?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>OpenAPI format</a>, which can be used for client-side validation.</p><p>To learn more about APISIX&rsquo;s other capabilities as an API gateway, see <a href="https://apisix.apache.org/?utm_source=navendu_blog&utm_medium=referral&utm_campaign=your-api-requests-should-be-validated" target=_blank>apisix.apache.org</a>.</p><section class=subscribe-content><hr><p>Thank you for reading <i>"Your API Requests Should Be Validated."</i></p><p>Subscribe via <a href=/subscribe>email</a> or
<a href=/index.xml target=_blank>RSS feed</a> to be the first to receive
my content.</p><p>If you liked this post, check out my <a href=/categories/featured>featured posts</a> or learn more <a href=/about>about me</a>.</p></section><section class=subscription-form><form action="https://navendu.us5.list-manage.com/subscribe/post-json?u=fb9ffeb3ee6bc8aaf1d5b8a98&id=5ff8367bc1&c=?" method=post autocomplete=off class=subscribe-form><div class=subscribe-input><input type=email name=EMAIL id=email required placeholder="Email Address ↵" title="Email Address"></div><input value=Subscribe type=submit class=subscribe-button title=Subscribe></form><section class=entry-content><div class=subscribe-message>Get a biweekly dose of tech news, curated content, and uninterrupted musings.</div></section></section><script>$(".subscribe-form").submit(function(d){var a,b,c;d.preventDefault(),a=$(this),b=a.attr("action"),c=a.attr("method"),$.ajax({type:c,url:b,data:a.serialize(),dataType:`jsonp`,success:function(b){b.result===`success`?(a.find(".subscribe-button").attr("value","Subscribed!"),$(".subscribe-message").html("Thank you for subscribing! Check your inbox and add me in your contacts to not miss an issue! <a target='_blank' href='https://twitter.com/intent/tweet?url=https%3A%2F%2Fnavendu.me&text=I%20just%20subscribed%20to%20@sudo_navendu%27s%20blog%21%20Check%20it%20out%21&hashtags=OpenSource%2CDevelopers%2CDEVCommunity'>Tweet about it</a>!"),$(".subscribe-form :input").prop("disabled",!0)):(a.find(".subscribe-button").attr("value","Failed to Subscribe! Click again to retry"),$(".subscribe-message").html("There was an error subscribing you to my blog. "+b.msg+"."),a[0].reset()),console.log(b)},error:function(b){console.log("An error occurred."),console.log(b),a[0].reset()}})})</script></div><footer class=post-footer><ul class=post-tags><li><a href=https://navendu.me/tags/apache-apisix/>apache apisix</a></li><li><a href=https://navendu.me/tags/api-gateway/>api gateway</a></li><li><a href=https://navendu.me/tags/tutorials/>tutorials</a></li></ul><nav class=paginav><a class=prev href=https://navendu.me/posts/rate-limit/><span class=title>« Prev</span><br><span>Rate Limit Your APIs With Apache APISIX</span></a>
<a class=next href=https://navendu.me/posts/data-mask-plugin/><span class=title>Next »</span><br><span>Creating a Custom Data Mask Plugin</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on twitter" href="https://twitter.com/intent/tweet/?text=Your%20API%20Requests%20Should%20Be%20Validated&url=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f&hashtags=apacheapisix%2capigateway%2ctutorials"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f&title=Your%20API%20Requests%20Should%20Be%20Validated&summary=Your%20API%20Requests%20Should%20Be%20Validated&source=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f&title=Your%20API%20Requests%20Should%20Be%20Validated"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on whatsapp" href="https://api.whatsapp.com/send?text=Your%20API%20Requests%20Should%20Be%20Validated%20-%20https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Your API Requests Should Be Validated on telegram" href="https://telegram.me/share/url?text=Your%20API%20Requests%20Should%20Be%20Validated&url=https%3a%2f%2fnavendu.me%2fposts%2frequest-validation%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>This work by <a href=https://navendu.me/about/#about-me>Navendu Pottekkat</a></span>
<span>is licensed under <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script><script>for(var els=document.getElementsByClassName("highlight"),i=0,title,code,newNode;i<els.length;i++)title=els[i].title,code=els[i].firstElementChild.firstElementChild,title.length&&(newNode=document.createElement("div"),newNode.textContent=title,newNode.classList.add("highlight-title"),code.parentNode.insertBefore(newNode,code))</script></body></html>